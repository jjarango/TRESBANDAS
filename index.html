<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador de Billar (Estilo Kozoom)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Estilo personalizado para la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Evitar que los inputs de número muestren flechas */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Resaltado del jugador activo */
        .player-active {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.7); /* Sombra brillante amarilla */
            border-color: #FACC15; /* Amarillo de Tailwind */
        }
        /* NUEVO: Estilo para el fondo del jugador activo */
        .player-active-bg {
            background-color: #6a0f13;
        }
        /* Estilos para el texto grande y responsive */
        .text-score {
            font-size: 6rem; /* Default para pantallas grandes */
        }
        @media (max-width: 768px) { /* md breakpoint */
            .text-score {
                font-size: 4.5rem; /* Para pantallas medianas/pequeñas */
            }
        }
        @media (max-width: 640px) { /* sm breakpoint */
            .text-score {
                font-size: 3.5rem; /* Para móviles */
            }
        }
        .text-innings {
            font-size: 4rem;
        }
        @media (max-width: 768px) {
            .text-innings {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-2 sm:p-4">

    <div id="setup-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full max-h-screen overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-yellow-400 text-center">Configurar Partida</h3>
            
            <div class="mb-4">
                <label for="num-players" class="block text-gray-300 text-sm font-semibold mb-1">Número de jugadores:</label>
                <select id="num-players" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="1">1 Jugador</option>
                    <option value="2" selected>2 Jugadores</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="player1-setup-name" class="block text-gray-300 text-sm font-semibold mb-1">Nombre J1:</label>
                    <input type="text" id="player1-setup-name" value="Jugador 1" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <div id="player2-setup-container">
                    <label for="player2-setup-name" class="block text-gray-300 text-sm font-semibold mb-1">Nombre J2:</label>
                    <input type="text" id="player2-setup-name" value="Jugador 2" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
            </div>

            <hr class="border-gray-600 my-4">

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="setup-target-score" class="block text-yellow-200 text-sm font-semibold mb-1">Carambolas (Meta):</label>
                    <input type="number" id="setup-target-score" value="30" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-md text-center font-bold text-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <div>
                    <label for="setup-target-innings" class="block text-blue-200 text-sm font-semibold mb-1">Entradas (Límite):</label>
                    <input type="number" id="setup-target-innings" value="40" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-md text-center font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <button id="start-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-200">
                Empezar Partida
            </button>
        </div>
    </div>

    <div id="app-content" class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden hidden">
        
        <header class="bg-black/20 p-3 sm:p-4 text-center border-b border-gray-700">
            <h1 class="text-2xl sm:text-3xl font-bold text-yellow-400 mb-2">Marcador de Tres Bandas</h1>
            
            <div class="bg-yellow-800/30 text-yellow-200 text-xs sm:text-sm p-2 rounded-md mb-3 border border-yellow-700">
                <p>CADA JUGADOR, EN SU TURNO, DEBE MARCAR UN NÚMERO DE CARAMBOLAS.</p>
                <p>SI NO HIZO NINGUNA, DEBE DAR CLIC EN EL BOTÓN AZUL QUE DICE "Cambiar Turno / Fallo".</p>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-8">
                <div class="text-center">
                    <label for="distancia" class="text-sm text-gray-400">Carambolas pactadas:</label>
                    <input type="number" id="distancia" readonly class="w-16 sm:w-20 bg-gray-700 text-white text-center text-lg font-bold rounded p-1 focus:outline-none focus:ring-2 focus:ring-yellow-400 cursor-not-allowed opacity-80">
                </div>
                
                <div class="text-center flex-1">
                    <div id="timer-display" class="text-4xl sm:text-5xl font-black text-white">00:00:00</div>
                    <div class="text-sm sm:text-lg font-bold text-gray-400 tracking-wider">TIEMPO DE PARTIDA</div>
                </div>

                <div class="text-center">
                    <div class="text-4xl sm:text-5xl font-black text-white flex items-baseline justify-center">
                        <span id="innings-display">0</span>
                        <span id="innings-limit-display" class="text-2xl text-gray-500 ml-1 hidden">/ 40</span>
                    </div>
                    <div class="text-sm sm:text-lg font-bold text-gray-400 tracking-wider">ENTRADAS</div>
                </div>
            </div>
        </header>

        <div class="bg-gray-700/50 p-3 sm:p-4 text-center text-xl sm:text-2xl border-b border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center md:space-x-4">
                <div class="w-full md:w-2/5 text-center md:text-left mb-2 md:mb-0">
                    <span id="summary-name1" class="font-bold text-yellow-400">Jugador 1</span>: 
                    <span id="summary-score1" class="font-bold text-white">0</span>
                    (<span id="summary-avg1" class="text-gray-300 text-lg sm:text-xl">0.000</span>)
                </div>
                
                <div class="w-full md:w-1/5 text-center font-black text-white order-first md:order-none mb-2 md:mb-0">
                    Entrada: <span id="summary-innings">0</span>
                </div>

                <div id="summary-player2" class="w-full md:w-2/5 text-center md:text-right">
                    <span id="summary-name2" class="font-bold text-yellow-400">Jugador 2</span>: 
                    <span id="summary-score2" class="font-bold text-white">0</span>
                    (<span id="summary-avg2" class="text-gray-300 text-lg sm:text-xl">0.000</span>)
                </div>
            </div>
        </div>

        <main class="flex flex-col md:flex-row">
            
            <div id="player1-panel" class="relative w-full md:w-1/2 p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gray-700/50 border-t-4 border-transparent transition-all duration-300">
                
                <div class="absolute top-2 right-2 sm:top-4 sm:right-4 w-[35%] min-w-[110px] bg-black rounded-xl border-2 border-gray-600 shadow-xl flex flex-col items-center justify-center p-2 sm:p-3 z-20">
                    <span class="text-xs sm:text-sm text-gray-400 uppercase tracking-widest font-bold">Total</span>
                    <span id="total-score-box-1" class="text-3xl sm:text-5xl font-black text-white leading-none mt-1">0</span>
                </div>

                <input type="text" id="player1-name" value="Jugador 1" class="text-2xl sm:text-3xl font-bold bg-transparent text-white text-center rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3 sm:mb-4 pr-24 sm:pr-32">
                
                <div id="score1-display" class="text-score font-black text-yellow-400 my-4 sm:my-8 cursor-pointer relative" title="Clic para sumar 1 punto">
                    0
                    <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-yellow-600 font-bold uppercase tracking-widest whitespace-nowrap">Serie Actual</span>
                </div>
                
                <div class="text-xl sm:text-3xl font-bold text-white mb-4 sm:mb-6">
                    Promedio: <span id="avg1-display">0.000</span>
                </div>

                <div class="flex space-x-2 sm:space-x-3 w-full">
                    <button id="add-point-1" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                        +1 Carambola
                    </button>
                    <button id="undo-point-1" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-5 rounded-lg text-base sm:text-lg shadow-lg transition duration-200" title="Deshacer punto">
                        &#x21A9;
                    </button>
                </div>
            </div>
            
            <div id="player2-panel" class="relative w-full md:w-1/2 p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gray-800/50 border-t-4 border-transparent transition-all duration-300 md:border-l border-gray-700">
                
                <div class="absolute top-2 right-2 sm:top-4 sm:right-4 w-[35%] min-w-[110px] bg-black rounded-xl border-2 border-gray-600 shadow-xl flex flex-col items-center justify-center p-2 sm:p-3 z-20">
                    <span class="text-xs sm:text-sm text-gray-400 uppercase tracking-widest font-bold">Total</span>
                    <span id="total-score-box-2" class="text-3xl sm:text-5xl font-black text-white leading-none mt-1">0</span>
                </div>

                <input type="text" id="player2-name" value="Jugador 2" class="text-2xl sm:text-3xl font-bold bg-transparent text-white text-center rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3 sm:mb-4 pr-24 sm:pr-32">
                
                <div id="score2-display" class="text-score font-black text-yellow-400 my-4 sm:my-8 cursor-pointer relative" title="Clic para sumar 1 punto">
                    0
                    <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-yellow-600 font-bold uppercase tracking-widest whitespace-nowrap">Serie Actual</span>
                </div>
                
                <div class="text-xl sm:text-3xl font-bold text-white mb-4 sm:mb-6">
                    Promedio: <span id="avg2-display">0.000</span>
                </div>

                <div class="flex space-x-2 sm:space-x-3 w-full">
                    <button id="add-point-2" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                        +1 Carambola
                    </button>
                    <button id="undo-point-2" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-5 rounded-lg text-base sm:text-lg shadow-lg transition duration-200" title="Deshacer punto">
                        &#x21A9;
                    </button>
                </div>
            </div>

        </main>

        <footer class="p-3 sm:p-4 bg-black/20 flex flex-col md:flex-row justify-center items-center space-y-3 md:space-y-0 md:space-x-4 border-t border-gray-700">
            <button id="next-inning-btn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Cambiar Turno / Fallo
            </button>
            <button id="undo-btn" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Deshacer Última Acción
            </button>
            <button id="pause-timer-btn" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Pausa
            </button>
            <button id="finish-game-btn" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Terminar Partida
            </button>
            <button id="reset-btn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Reiniciar
            </button>
        </footer>

    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-white">¿Estás seguro?</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Esta acción no se puede deshacer.</p>
            <div id="modal-results" class="hidden text-left text-gray-200 space-y-2">
                </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">Cancelar</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ESTADO DEL JUEGO ---
            let state = {
                score1: 0, // Puntuación total J1
                score2: 0, // Puntuación total J2
                inningScore1: 0, // Puntuación de la entrada actual J1
                inningScore2: 0, // Puntuación de la entrada actual J2
                innings: 0,
                currentPlayer: 1, // 1 o 2
                startTime: null,
                timerInterval: null,
                numPlayers: 2,
                isPaused: false,
                pausedTime: 0,
                pauseStartTime: null,
                // NUEVOS ESTADOS DE META
                targetScore: 30,
                targetInnings: 0 // 0 significa sin límite si el usuario lo deja vacío o 0
            };
 
            // Historial para deshacer
            let history = [];

            // --- ELEMENTOS DEL DOM ---
            const appContent = document.getElementById('app-content');
            const setupModal = document.getElementById('setup-modal');
            const numPlayersSelect = document.getElementById('num-players');
            const player1SetupName = document.getElementById('player1-setup-name');
            const player2SetupName = document.getElementById('player2-setup-name');
            const player2SetupContainer = document.getElementById('player2-setup-container');
            const startGameBtn = document.getElementById('start-game-btn');
            
            // NUEVOS INPUTS SETUP
            const setupTargetScore = document.getElementById('setup-target-score');
            const setupTargetInnings = document.getElementById('setup-target-innings');
            const distanciaInput = document.getElementById('distancia'); // Input del header
            const inningsLimitDisplay = document.getElementById('innings-limit-display');

            const score1Display = document.getElementById('score1-display');
            const score2Display = document.getElementById('score2-display');
            const avg1Display = document.getElementById('avg1-display');
            const avg2Display = document.getElementById('avg2-display');
            const inningsDisplay = document.getElementById('innings-display');
            const panel1 = document.getElementById('player1-panel');
            const panel2 = document.getElementById('player2-panel');
            const player1NameInput = document.getElementById('player1-name');
            const player2NameInput = document.getElementById('player2-name');

            // NUEVAS CAJAS DE TOTAL
            const totalScoreBox1 = document.getElementById('total-score-box-1');
            const totalScoreBox2 = document.getElementById('total-score-box-2');

            const timerDisplay = document.getElementById('timer-display');
            
            // Resumen global
            const summaryScore1 = document.getElementById('summary-score1');
            const summaryScore2 = document.getElementById('summary-score2');
            const summaryAvg1 = document.getElementById('summary-avg1');
            const summaryAvg2 = document.getElementById('summary-avg2');
            const summaryInnings = document.getElementById('summary-innings');
            const summaryName1 = document.getElementById('summary-name1');
            const summaryName2 = document.getElementById('summary-name2');
            const summaryPlayer2 = document.getElementById('summary-player2');

            // Botones
            const addPoint1Btn = document.getElementById('add-point-1');
            const addPoint2Btn = document.getElementById('add-point-2');
            const undoPoint1Btn = document.getElementById('undo-point-1');
            const undoPoint2Btn = document.getElementById('undo-point-2');
            const nextInningBtn = document.getElementById('next-inning-btn');
            const undoBtn = document.getElementById('undo-btn');
            const resetBtn = document.getElementById('reset-btn');
            const finishGameBtn = document.getElementById('finish-game-btn');
            const pauseTimerBtn = document.getElementById('pause-timer-btn');
 
            // Modal de confirmación/resultados
            const modal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalResults = document.getElementById('modal-results');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            let confirmCallback = null;

            // --- FUNCIONES PRINCIPALES ---

            function formatTime(seconds) {
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            function startTimer() {
                if (!state.startTime) {
                    state.startTime = Date.now();
                }
                if (state.timerInterval) {
                    return; 
                }
                state.timerInterval = setInterval(() => {
                    if (state.isPaused) return; 
                    const elapsedMs = Date.now() - state.startTime - state.pausedTime;
                    const elapsedSeconds = Math.floor(elapsedMs / 1000);
                    timerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
            }
 
            function stopTimer() {
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
            }

            function saveState() {
                history.push(JSON.parse(JSON.stringify(state)));
                if (history.length > 50) { 
                    history.shift(); 
                }
            }

            function calculateAvg(score, innings) {
                if (innings === 0 || score === 0) return '0.000';
                return (score / innings).toFixed(3);
            }

            /**
             * Lógica de actualización de colores para las cajas de TOTAL
             */
            function updateTotalScoreColors() {
                // Reiniciar estilos base
                totalScoreBox1.style.color = 'white';
                totalScoreBox2.style.color = 'white';

                if (state.numPlayers === 2) {
                    // Colores de la petición
                    const winningColor = '#22c55e'; 
                    const losingColor = '#D12E45'; 

                    if (state.score1 > state.score2) {
                        // J1 Ganando (Verde), J2 Perdiendo (Rojo)
                        totalScoreBox1.style.color = winningColor; 
                        totalScoreBox2.style.color = losingColor; 
                    } else if (state.score2 > state.score1) {
                        // J2 Ganando (Verde), J1 Perdiendo (Rojo)
                        totalScoreBox2.style.color = winningColor;
                        totalScoreBox1.style.color = losingColor;
                    } else {
                        // Empate (Blanco)
                        totalScoreBox1.style.color = 'white';
                        totalScoreBox2.style.color = 'white';
                    }
                }
            }

            function updateDisplay() {
                // Puntuaciones de Serie Actual (Grande)
                score1Display.textContent = state.inningScore1;
                player1NameInput.value = player1SetupName.value;
                
                // Puntuaciones Totales (Nuevas Cajas)
                totalScoreBox1.textContent = state.score1;
                
                if (state.numPlayers === 2) {
                    score2Display.textContent = state.inningScore2;
                    player2NameInput.value = player2SetupName.value;
                    totalScoreBox2.textContent = state.score2;
                }
                
                // Aplicar lógica de colores
                updateTotalScoreColors();

                // Entradas
                inningsDisplay.textContent = state.innings;

                // Promedios
                let p1AvgInnings = 0;
                let p2AvgInnings = 0;

                if (state.innings > 0) {
                    if (state.currentPlayer === 1) { 
                        p1AvgInnings = state.innings - 1;
                        p2AvgInnings = state.innings - 1; 
                    } else { 
                        p1AvgInnings = state.innings;
                        p2AvgInnings = state.innings - 1;
                    }
                }
                
                if (state.innings === 0) {
                     avg1Display.textContent = '0.000';
                     avg2Display.textContent = '0.000';
                } else {
                    avg1Display.textContent = calculateAvg(state.score1, p1AvgInnings > 0 ? p1AvgInnings : 1);
                    if (state.numPlayers === 2) {
                        avg2Display.textContent = calculateAvg(state.score2, p2AvgInnings > 0 ? p2AvgInnings : 1);
                    }
                }
                
                // Clases de jugador activo
                panel1.classList.remove('player-active', 'border-yellow-400', 'player-active-bg');
                panel2.classList.remove('player-active', 'border-yellow-400', 'player-active-bg');
                
                panel1.classList.add('bg-gray-700/50');
                panel2.classList.add('bg-gray-800/50');
                panel1.classList.remove('player-active-bg');
                panel2.classList.remove('player-active-bg');

                if (state.currentPlayer === 1) {
                    panel1.classList.add('player-active', 'border-yellow-400', 'player-active-bg');
                    panel1.classList.remove('bg-gray-700/50'); 
                } else if (state.numPlayers === 2) {
                    panel2.classList.add('player-active', 'border-yellow-400', 'player-active-bg');
                    panel2.classList.remove('bg-gray-800/50'); 
                }
 
                // Actualizar resumen global
                summaryName1.textContent = player1NameInput.value;
                summaryScore1.textContent = state.score1;
                summaryAvg1.textContent = calculateAvg(state.score1, p1AvgInnings > 0 ? p1AvgInnings : 1);
                
                if (state.numPlayers === 2) { 
                    summaryPlayer2.classList.remove('hidden'); 
                    summaryName2.textContent = player2NameInput.value; 
                    summaryScore2.textContent = state.score2;
                    summaryAvg2.textContent = calculateAvg(state.score2, p2AvgInnings > 0 ? p2AvgInnings : 1);
                } else {
                    summaryPlayer2.classList.add('hidden'); 
                }
                
                summaryInnings.textContent = state.innings;

                // Ocultar/mostrar panel J2 y caja total J2
                if (state.numPlayers === 1) {
                    panel2.classList.add('hidden');
                    panel1.classList.remove('md:w-1/2');
                    panel1.classList.add('w-full');
                } else {
                    panel2.classList.remove('hidden');
                    panel1.classList.add('md:w-1/2');
                    panel1.classList.remove('w-full');
                }

                // Botón pausa
                if (state.isPaused) {
                    pauseTimerBtn.textContent = 'Reanudar';
                    pauseTimerBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                    pauseTimerBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                } else {
                    pauseTimerBtn.textContent = 'Pausa';
                    pauseTimerBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
                    pauseTimerBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                }
            }
 
            function showConfirmation(title, message, onConfirm, showResults = false, resultsHtml = '') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalResults.innerHTML = resultsHtml;

                if (showResults) {
                    modalMessage.classList.add('hidden');
                    modalResults.classList.remove('hidden');
                    modalConfirmBtn.classList.add('hidden'); 
                    modalCancelBtn.textContent = 'Cerrar';
                    modalCancelBtn.onclick = hideConfirmation; 
                } else {
                    modalMessage.classList.remove('hidden');
                    modalResults.classList.add('hidden');
                    modalConfirmBtn.classList.remove('hidden');
                    modalCancelBtn.textContent = 'Cancelar';
                    modalCancelBtn.onclick = hideConfirmation; 
                    confirmCallback = onConfirm;
                }
                modal.classList.remove('hidden');
            }

            function hideConfirmation() {
                modal.classList.add('hidden');
                confirmCallback = null;
                modalCancelBtn.textContent = 'Cancelar';
            }


            // --- MANEJADORES DE EVENTOS ---

            numPlayersSelect.addEventListener('change', (e) => {
                if (e.target.value === '1') {
                    player2SetupContainer.classList.add('hidden');
                } else {
                    player2SetupContainer.classList.remove('hidden');
                }
            });

            startGameBtn.addEventListener('click', () => {
                state.numPlayers = parseInt(numPlayersSelect.value);
                player1NameInput.value = player1SetupName.value;
                
                // Capturar metas
                state.targetScore = parseInt(setupTargetScore.value) || 0;
                state.targetInnings = parseInt(setupTargetInnings.value) || 0;
                
                // Actualizar UI del Header
                distanciaInput.value = state.targetScore > 0 ? state.targetScore : '';
                
                if (state.targetInnings > 0) {
                    inningsLimitDisplay.textContent = `/ ${state.targetInnings}`;
                    inningsLimitDisplay.classList.remove('hidden');
                } else {
                    inningsLimitDisplay.classList.add('hidden');
                }

                if (state.numPlayers === 2) {
                    player2NameInput.value = player2SetupName.value;
                }

                setupModal.classList.add('hidden');
                appContent.classList.remove('hidden');
                initializeGame(); 
            });

            // Sumar punto J1
            function handleAddPoint1() {
                saveState();
                state.score1++; 
                state.inningScore1++; 
                state.currentPlayer = 1;
                if (state.innings === 0) { 
                    state.innings = 1;
                }
                startTimer();
                updateDisplay();
            }
            addPoint1Btn.addEventListener('click', handleAddPoint1);
            score1Display.addEventListener('click', handleAddPoint1);

            // Sumar punto J2
            function handleAddPoint2() {
                if (state.numPlayers === 1) return; 
                saveState();
                state.score2++; 
                state.inningScore2++; 
                state.currentPlayer = 2;
                if (state.innings === 0) { 
                    state.innings = 1;
                }
                startTimer();
                updateDisplay();
            }
            addPoint2Btn.addEventListener('click', handleAddPoint2);
            score2Display.addEventListener('click', handleAddPoint2);

            // Deshacer J1
            undoPoint1Btn.addEventListener('click', () => {
                if (state.score1 > 0 && state.inningScore1 > 0) {
                    saveState();
                    state.score1--;
                    state.inningScore1--;
                    updateDisplay();
                }
            });

            // Deshacer J2
            undoPoint2Btn.addEventListener('click', () => {
                if (state.numPlayers === 1) return;
                if (state.score2 > 0 && state.inningScore2 > 0) {
                    saveState();
                    state.score2--;
                    state.inningScore2--;
                    updateDisplay();
                }
            });

            // Siguiente turno
            nextInningBtn.addEventListener('click', () => {
                saveState();
                
                state.inningScore1 = 0;
                state.inningScore2 = 0;
                
                if (state.numPlayers === 1) {
                    state.innings++;
                } else {
                    if (state.currentPlayer === 1) {
                        state.currentPlayer = 2; 
                    } else {
                        state.currentPlayer = 1; 
                        state.innings++; 
                    }
                }
                if (state.innings === 0) { 
                    state.innings = 1;
                }
                startTimer();
                updateDisplay();
            });

            // Deshacer general
            undoBtn.addEventListener('click', () => {
                if (history.length > 0) {
                    const lastState = history.pop();
                    if (!lastState.timerInterval) {
                        stopTimer();
                    }
                    state = lastState; 
                    if (state.startTime) { 
                        startTimer();
                    } else {
                        stopTimer(); 
                        timerDisplay.textContent = '00:00:00';
                    }
                    updateDisplay();
                }
            });

            // Pausa
            pauseTimerBtn.addEventListener('click', () => {
                if (!state.startTime) return; 

                if (state.isPaused) {
                    state.isPaused = false;
                    if (state.pauseStartTime) {
                        state.pausedTime += (Date.now() - state.pauseStartTime);
                    }
                    state.pauseStartTime = null;
                } else {
                    state.isPaused = true;
                    state.pauseStartTime = Date.now(); 
                }
                updateDisplay(); 
            });
 
            // Terminar
            finishGameBtn.addEventListener('click', () => {
                if (!state.isPaused && state.startTime) {
                    state.isPaused = true;
                    state.pauseStartTime = Date.now();
                }
 
                let durationSeconds = 0;
                if (state.startTime) {
                    let elapsedMs = 0;
                    if (state.pauseStartTime) { 
                        elapsedMs = (state.pauseStartTime - state.startTime) - state.pausedTime;
                    } else if (state.startTime) { 
                        elapsedMs = Date.now() - state.startTime;
                    } else { 
                        elapsedMs = 0;
                    }
                    durationSeconds = Math.floor(elapsedMs / 1000);
                    if (durationSeconds < 0) durationSeconds = 0; 
                }
                
                const durationFormatted = formatTime(durationSeconds);
 
                let finalP1Innings = state.innings;
                let finalP2Innings = state.innings;

                if (state.innings === 0) { 
                    finalP1Innings = 1;
                    finalP2Innings = 1;
                } else if (state.numPlayers === 2) {
                    if (state.currentPlayer === 1 && state.innings > 0) {
                        finalP2Innings = state.innings - 1;
                    }
                }

                const finalAvg1 = calculateAvg(state.score1, finalP1Innings > 0 ? finalP1Innings : 1);
                const finalAvg2 = calculateAvg(state.score2, finalP2Innings > 0 ? finalP2Innings : 1);


                let resultsHtml = `
                    <h4 class="text-xl font-bold text-yellow-400 mb-4">Resultados de la Partida:</h4>
                    <p><strong>Duración:</strong> ${durationFormatted}</p>
                    <p><strong>Entradas Totales:</strong> ${state.innings}</p>
                    <hr class="my-3 border-gray-600">
                    <p><strong>${player1NameInput.value}:</strong></p>
                    <ul>
                        <li>Carambolas: ${state.score1}</li>
                        <li>Promedio: ${finalAvg1}</li>
                    </ul>
                `;

                if (state.numPlayers === 2) {
                    resultsHtml += `
                        <hr class="my-3 border-gray-600">
                        <p><strong>${player2NameInput.value}:</strong></p>
                        <ul>
                            <li>Carambolas: ${state.score2}</li>
                            <li>Promedio: ${finalAvg2}</li>
                        </ul>
                    `;
                }
                
                showConfirmation('Partida Terminada', '', null, true, resultsHtml);
            });


            // Resetear
            resetBtn.addEventListener('click', () => {
                showConfirmation(
                    'Reiniciar Aplicación', 
                    '¿Estás seguro de que quieres salir? Volverás a la pantalla de configuración.', 
                    () => {
                        stopTimer(); 
                        appContent.classList.add('hidden');
                        setupModal.classList.remove('hidden');
                        hideConfirmation();
                    }
                );
            });
 
            modalCancelBtn.addEventListener('click', hideConfirmation);
            modalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
            });

            function initializeGame() {
                stopTimer(); 
                state = {
                    score1: 0,
                    score2: 0,
                    inningScore1: 0, 
                    inningScore2: 0, 
                    innings: 0,
                    currentPlayer: 1,
                    startTime: null,
                    timerInterval: null,
                    numPlayers: state.numPlayers,
                    isPaused: false,
                    pausedTime: 0,
                    pauseStartTime: null,
                    // Persistir las metas elegidas
                    targetScore: state.targetScore,
                    targetInnings: state.targetInnings
                };
                history = []; 
                timerDisplay.textContent = '00:00:00';
                updateDisplay();
            }
        });
    </script>
</body>
</html>