<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador de Billar (Estilo Kozoom)</title>
    <!-- Carga de Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Estilo personalizado para la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Evitar que los inputs de número muestren flechas */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Resaltado del jugador activo */
        .player-active {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.7); /* Sombra brillante amarilla */
            border-color: #FACC15; /* Amarillo de Tailwind */
        }
        /* NUEVO: Estilo para el fondo del jugador activo */
        .player-active-bg {
            background-color: #6a0f13;
        }
        /* Estilos para el texto grande y responsive */
        .text-score {
            font-size: 6rem; /* Default para pantallas grandes */
        }
        @media (max-width: 768px) { /* md breakpoint */
            .text-score {
                font-size: 4.5rem; /* Para pantallas medianas/pequeñas */
            }
        }
        @media (max-width: 640px) { /* sm breakpoint */
            .text-score {
                font-size: 3.5rem; /* Para móviles */
            }
        }
        .text-innings {
            font-size: 4rem;
        }
        @media (max-width: 768px) {
            .text-innings {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-2 sm:p-4">

    <!-- Modal de configuración inicial --><div id="setup-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-3xl font-bold mb-6 text-yellow-400 text-center">Configurar Partida</h3>
            
            <div class="mb-6">
                <label for="num-players" class="block text-gray-300 text-lg font-semibold mb-2">Número de jugadores:</label>
                <select id="num-players" class="w-full p-3 bg-gray-700 text-white rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="1">1 Jugador</option>
                    <option value="2" selected>2 Jugadores</option>
                </select>
            </div>

            <div class="mb-6">
                <label for="player1-setup-name" class="block text-gray-300 text-lg font-semibold mb-2">Nombre Jugador 1:</label>
                <input type="text" id="player1-setup-name" value="Jugador 1" class="w-full p-3 bg-gray-700 text-white rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>

            <div id="player2-setup-container" class="mb-6">
                <label for="player2-setup-name" class="block text-gray-300 text-lg font-semibold mb-2">Nombre Jugador 2:</label>
                <input type="text" id="player2-setup-name" value="Jugador 2" class="w-full p-3 bg-gray-700 text-white rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>

            <button id="start-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-200">
                Empezar Partida
            </button>
        </div>
    </div>

    <!-- Contenido principal de la aplicación --><div id="app-content" class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden hidden">
        
        <!-- ENCABEZADO Y ENTRADAS / RELOJ / AVISO --><header class="bg-black/20 p-3 sm:p-4 text-center border-b border-gray-700">
            <h1 class="text-2xl sm:text-3xl font-bold text-yellow-400 mb-2">Marcador de Tres Bandas</h1>
            
            <!-- Aviso instructivo --><div class="bg-yellow-800/30 text-yellow-200 text-xs sm:text-sm p-2 rounded-md mb-3 border border-yellow-700">
                <p>CADA JUGADOR, EN SU TURNO, DEBE MARCAR UN NÚMERO DE CARAMBOLAS.</p>
                <p>SI NO HIZO NINGUNA, DEBE DAR CLIC EN EL BOTÓN AZUL QUE DICE "Cambiar Turno / Fallo".</p>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-8">
                <div class="text-center">
                    <label for="distancia" class="text-sm text-gray-400">Carambolas pactadas:</label>
                    <input type="number" id="distancia" value="30" class="w-16 sm:w-20 bg-gray-700 text-white text-center text-lg font-bold rounded p-1 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                
                <div class="text-center flex-1">
                    <div id="timer-display" class="text-4xl sm:text-5xl font-black text-white">00:00:00</div>
                    <div class="text-sm sm:text-lg font-bold text-gray-400 tracking-wider">TIEMPO DE PARTIDA</div>
                </div>

                <div class="text-center">
                    <div id="innings-display" class="text-4xl sm:text-5xl font-black text-white">0</div>
                    <div class="text-sm sm:text-lg font-bold text-gray-400 tracking-wider">ENTRADAS</div>
                </div>
            </div>
        </header>

        <!-- RESUMEN GLOBAL (Tamaño aumentado) --><div class="bg-gray-700/50 p-3 sm:p-4 text-center text-xl sm:text-2xl border-b border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center md:space-x-4">
                <!-- P1 Summary -->
                <div class="w-full md:w-2/5 text-center md:text-left mb-2 md:mb-0">
                    <span id="summary-name1" class="font-bold text-yellow-400">Jugador 1</span>: 
                    <span id="summary-score1" class="font-bold text-white">0</span>
                    (<span id="summary-avg1" class="text-gray-300 text-lg sm:text-xl">0.000</span>)
                </div>
                
                <!-- Innings Summary -->
                <div class="w-full md:w-1/5 text-center font-black text-white order-first md:order-none mb-2 md:mb-0">
                    Entrada: <span id="summary-innings">0</span>
                </div>

                <!-- P2 Summary -->
                <div id="summary-player2" class="w-full md:w-2/5 text-center md:text-right">
                    <span id="summary-name2" class="font-bold text-yellow-400">Jugador 2</span>: 
                    <span id="summary-score2" class="font-bold text-white">0</span>
                    (<span id="summary-avg2" class="text-gray-300 text-lg sm:text-xl">0.000</span>)
                </div>
            </div>
        </div>

        <!-- PANELES DE JUGADORES --><main class="flex flex-col md:flex-row">
            
            <!-- JUGADOR 1 --><div id="player1-panel" class="w-full md:w-1/2 p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gray-700/50 border-t-4 border-transparent transition-all duration-300">
                <input type="text" id="player1-name" value="Jugador 1" class="text-2xl sm:text-3xl font-bold bg-transparent text-white text-center rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3 sm:mb-4">
                
                <!-- ESTE ES EL MARCADOR DE LA ENTRADA ACTUAL --><div id="score1-display" class="text-score font-black text-yellow-400 my-4 sm:my-8 cursor-pointer" title="Clic para sumar 1 punto">0</div>
                
                <div class="text-xl sm:text-3xl font-bold text-white mb-4 sm:mb-6">
                    Promedio (Total): <span id="avg1-display">0.000</span>
                </div>

                <!-- Botones de control del jugador 1 --><div class="flex space-x-2 sm:space-x-3 w-full">
                    <button id="add-point-1" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                        +1 Carambola
                    </button>
                    <button id="undo-point-1" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-5 rounded-lg text-base sm:text-lg shadow-lg transition duration-200" title="Deshacer punto">
                        &#x21A9; <!-- Flecha de deshacer --></button>
                </div>
            </div>
            
            <!-- JUGADOR 2 (Solo visible si hay 2 jugadores) --><div id="player2-panel" class="w-full md:w-1/2 p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gray-800/50 border-t-4 border-transparent transition-all duration-300 md:border-l border-gray-700">
                <input type="text" id="player2-name" value="Jugador 2" class="text-2xl sm:text-3xl font-bold bg-transparent text-white text-center rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3 sm:mb-4">
                
                <!-- ESTE ES EL MARCADOR DE LA ENTRADA ACTUAL --><div id="score2-display" class="text-score font-black text-yellow-400 my-4 sm:my-8 cursor-pointer" title="Clic para sumar 1 punto">0</div>
                
                <div class="text-xl sm:text-3xl font-bold text-white mb-4 sm:mb-6">
                    Promedio (Total): <span id="avg2-display">0.000</span>
                </div>

                <!-- Botones de control del jugador 2 --><div class="flex space-x-2 sm:space-x-3 w-full">
                    <button id="add-point-2" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                        +1 Carambola
                    </button>
                    <button id="undo-point-2" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-5 rounded-lg text-base sm:text-lg shadow-lg transition duration-200" title="Deshacer punto">
                        &#x21A9; <!-- Flecha de deshacer --></button>
                </div>
            </div>

        </main>

        <!-- CONTROLES GLOBALES --><footer class="p-3 sm:p-4 bg-black/20 flex flex-col md:flex-row justify-center items-center space-y-3 md:space-y-0 md:space-x-4 border-t border-gray-700">
            <button id="next-inning-btn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Cambiar Turno / Fallo
            </button>
            <button id="undo-btn" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Deshacer Última Acción
            </button>
            <!-- NUEVO BOTÓN DE PAUSA -->
            <button id="pause-timer-btn" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Pausa
            </button>
            <button id="finish-game-btn" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Terminar Partida
            </button>
            <button id="reset-btn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Reiniciar Partida
            </button>
        </footer>

    </div>

    <!-- Div para el modal de confirmación y resultados --><div id="confirmation-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-white">¿Estás seguro?</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Esta acción no se puede deshacer.</p>
            <div id="modal-results" class="hidden text-left text-gray-200 space-y-2">
                <!-- Aquí se mostrarán los resultados de la partida --></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">Cancelar</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ESTADO DEL JUEGO ---
            let state = {
                score1: 0, // Puntuación total J1
                score2: 0, // Puntuación total J2
                inningScore1: 0, // Puntuación de la entrada actual J1
                inningScore2: 0, // Puntuación de la entrada actual J2
                innings: 0,
                currentPlayer: 1, // 1 o 2
                startTime: null,
                timerInterval: null,
                numPlayers: 2, // Por defecto 2 jugadores
                // NUEVAS PROPIEDADES PARA PAUSA
                isPaused: false,
                pausedTime: 0, // Tiempo total en milisegundos que el juego estuvo pausado
                pauseStartTime: null // Timestamp de cuándo se pausó
            };
 
            // Historial para deshacer
            let history = [];

            // --- ELEMENTOS DEL DOM ---
            const appContent = document.getElementById('app-content');
            const setupModal = document.getElementById('setup-modal');
            const numPlayersSelect = document.getElementById('num-players');
            const player1SetupName = document.getElementById('player1-setup-name');
            const player2SetupName = document.getElementById('player2-setup-name');
            const player2SetupContainer = document.getElementById('player2-setup-container');
            const startGameBtn = document.getElementById('start-game-btn');

            const score1Display = document.getElementById('score1-display');
            const score2Display = document.getElementById('score2-display');
            const avg1Display = document.getElementById('avg1-display');
            const avg2Display = document.getElementById('avg2-display');
            const inningsDisplay = document.getElementById('innings-display');
            const panel1 = document.getElementById('player1-panel');
            const panel2 = document.getElementById('player2-panel');
            const player1NameInput = document.getElementById('player1-name');
            const player2NameInput = document.getElementById('player2-name');

            const timerDisplay = document.getElementById('timer-display');
            
            // Resumen global
            const summaryScore1 = document.getElementById('summary-score1');
            const summaryScore2 = document.getElementById('summary-score2');
            const summaryAvg1 = document.getElementById('summary-avg1');
            const summaryAvg2 = document.getElementById('summary-avg2');
            const summaryInnings = document.getElementById('summary-innings');
            // NUEVOS ELEMENTOS DEL RESUMEN
            const summaryName1 = document.getElementById('summary-name1');
            const summaryName2 = document.getElementById('summary-name2');
            const summaryPlayer2 = document.getElementById('summary-player2');

            // Botones
            const addPoint1Btn = document.getElementById('add-point-1');
            const addPoint2Btn = document.getElementById('add-point-2');
            const undoPoint1Btn = document.getElementById('undo-point-1');
            const undoPoint2Btn = document.getElementById('undo-point-2');
            const nextInningBtn = document.getElementById('next-inning-btn');
            const undoBtn = document.getElementById('undo-btn');
            const resetBtn = document.getElementById('reset-btn');
            const finishGameBtn = document.getElementById('finish-game-btn');
            // NUEVO BOTÓN
            const pauseTimerBtn = document.getElementById('pause-timer-btn');
 
            // Modal de confirmación/resultados
            const modal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalResults = document.getElementById('modal-results');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            let confirmCallback = null;

            // --- FUNCIONES PRINCIPALES ---

            /**
             * Formatea un tiempo en segundos a HH:MM:SS.
             */
            function formatTime(seconds) {
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            /**
             * Inicia o actualiza el temporizador de la partida.
             */
            function startTimer() {
                if (!state.startTime) {
                    state.startTime = Date.now();
                }
                if (state.timerInterval) {
                    return; // Ya está corriendo
                }
                state.timerInterval = setInterval(() => {
                    // MODIFICACIÓN: Si está pausado, no actualices el display
                    if (state.isPaused) return; 

                    // MODIFICACIÓN: Calcular tiempo transcurrido restando el tiempo pausado
                    const elapsedMs = Date.now() - state.startTime - state.pausedTime;
                    const elapsedSeconds = Math.floor(elapsedMs / 1000);
                    timerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
            }
 
            /**
             * Detiene el temporizador.
             */
            function stopTimer() {
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
            }

            /**
             * Guarda el estado actual en el historial.
             */
            function saveState() {
                // Clona el estado para evitar mutaciones.
                // También clonamos el startTime para mantenerlo en el historial si se deshace un reset.
                history.push(JSON.parse(JSON.stringify(state)));
                if (history.length > 50) { // Aumentamos el historial para más deshacer
                    history.shift(); 
                }
            }

            /**
             * Calcula el promedio de un jugador.
             */
            function calculateAvg(score, innings) {
                if (innings === 0 || score === 0) return '0.000';
                return (score / innings).toFixed(3);
            }

            /**
             * Actualiza toda la UI basada en el estado actual.
             */
            function updateDisplay() {
                // Puntuaciones
                // MODIFICACIÓN: El display principal ahora muestra la PUNTUACIÓN DE LA ENTRADA
                score1Display.textContent = state.inningScore1;
                player1NameInput.value = player1SetupName.value;
                if (state.numPlayers === 2) {
                    // MODIFICACIÓN: El display principal ahora muestra la PUNTUACIÓN DE LA ENTRADA
                    score2Display.textContent = state.inningScore2;
                    player2NameInput.value = player2SetupName.value;
                }
                
                // Entradas y promedios
                inningsDisplay.textContent = state.innings;

                // Para calcular el promedio, el jugador solo tiene un promedio si ha completado al menos una entrada.
                // Si el J1 ha jugado 3 entradas, el J2 ha jugado 2. Cuando el J2 acaba su turno, ambos han jugado 3.
                // Cuando el J1 está en su turno de la entrada N, él ha jugado N-1 entradas completadas.
                // Cuando el J2 está en su turno de la entrada N, él ha jugado N-1 entradas completadas.
                // Cuando el J1 empieza la entrada N+1, ambos han jugado N.

                let p1AvgInnings = 0;
                let p2AvgInnings = 0;

                if (state.innings > 0) {
                    if (state.currentPlayer === 1) { // Turno del J1 en la entrada 'state.innings'
                        p1AvgInnings = state.innings - 1;
                        p2AvgInnings = state.innings - 1; // El J2 terminó su turno en la entrada anterior
                    } else { // Turno del J2 en la entrada 'state.innings'
                        p1AvgInnings = state.innings;
                        p2AvgInnings = state.innings - 1;
                    }
                }
                
                // Excepciones para el inicio de la partida y una sola entrada
                // El promedio se calcula sobre la PUNTUACIÓN TOTAL (state.score1)
                if (state.innings === 0) {
                     avg1Display.textContent = '0.000';
                     avg2Display.textContent = '0.000';
                } else {
                    avg1Display.textContent = calculateAvg(state.score1, p1AvgInnings > 0 ? p1AvgInnings : 1);
                    if (state.numPlayers === 2) {
                        avg2Display.textContent = calculateAvg(state.score2, p2AvgInnings > 0 ? p2AvgInnings : 1);
                    }
                }
                
                // MODIFICACIÓN: Se gestionan las clases de fondo por defecto y activa
                panel1.classList.remove('player-active', 'border-yellow-400', 'player-active-bg');
                panel2.classList.remove('player-active', 'border-yellow-400', 'player-active-bg');
                
                // Restaurar fondos por defecto (asegurándose de quitar el activo)
                panel1.classList.add('bg-gray-700/50');
                panel2.classList.add('bg-gray-800/50');
                panel1.classList.remove('player-active-bg');
                panel2.classList.remove('player-active-bg');

                if (state.currentPlayer === 1) {
                    panel1.classList.add('player-active', 'border-yellow-400', 'player-active-bg');
                    panel1.classList.remove('bg-gray-700/50'); // Quitar el fondo por defecto
                } else if (state.numPlayers === 2) {
                    panel2.classList.add('player-active', 'border-yellow-400', 'player-active-bg');
                    panel2.classList.remove('bg-gray-800/50'); // Quitar el fondo por defecto
                }
 
                // Actualizar resumen global (PUNTUACIÓN TOTAL)
                summaryName1.textContent = player1NameInput.value; // NUEVO
                summaryScore1.textContent = state.score1;
                summaryAvg1.textContent = calculateAvg(state.score1, p1AvgInnings > 0 ? p1AvgInnings : 1);
                
                if (state.numPlayers === 2) { // NUEVA LÓGICA
                    summaryPlayer2.classList.remove('hidden'); // NUEVO
                    summaryName2.textContent = player2NameInput.value; // NUEVO
                    summaryScore2.textContent = state.score2;
                    summaryAvg2.textContent = calculateAvg(state.score2, p2AvgInnings > 0 ? p2AvgInnings : 1);
                } else {
                    summaryPlayer2.classList.add('hidden'); // NUEVO
                }
                
                summaryInnings.textContent = state.innings;

                // Ocultar/mostrar panel del Jugador 2
                if (state.numPlayers === 1) {
                    panel2.classList.add('hidden');
                    panel1.classList.remove('md:w-1/2');
                    panel1.classList.add('w-full');
                } else {
                    panel2.classList.remove('hidden');
                    panel1.classList.add('md:w-1/2');
                    panel1.classList.remove('w-full');
                }

                // Sincronizar botón de pausa (por si se usó "Deshacer")
                if (state.isPaused) {
                    pauseTimerBtn.textContent = 'Reanudar';
                    pauseTimerBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                    pauseTimerBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                } else {
                    pauseTimerBtn.textContent = 'Pausa';
                    pauseTimerBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
                    pauseTimerBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                }
            }
 
            /**
             * Muestra un modal de confirmación o resultados.
             */
            function showConfirmation(title, message, onConfirm, showResults = false, resultsHtml = '') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalResults.innerHTML = resultsHtml;

                if (showResults) {
                    modalMessage.classList.add('hidden');
                    modalResults.classList.remove('hidden');
                    modalConfirmBtn.classList.add('hidden'); // No hay confirmación, solo OK
                    modalCancelBtn.textContent = 'Cerrar';
                    modalCancelBtn.onclick = hideConfirmation; // Cerrar el modal
                } else {
                    modalMessage.classList.remove('hidden');
                    modalResults.classList.add('hidden');
                    modalConfirmBtn.classList.remove('hidden');
                    modalCancelBtn.textContent = 'Cancelar';
                    modalCancelBtn.onclick = hideConfirmation; // Volver al comportamiento por defecto
                    confirmCallback = onConfirm;
                }
                modal.classList.remove('hidden');
            }

            /**
             * Oculta el modal.
             */
            function hideConfirmation() {
                modal.classList.add('hidden');
                confirmCallback = null;
                // Restaurar el texto del botón de cancelar por si fue modificado
                modalCancelBtn.textContent = 'Cancelar';
            }


            // --- MANEJADORES DE EVENTOS ---

            // Configuración inicial
            numPlayersSelect.addEventListener('change', (e) => {
                if (e.target.value === '1') {
                    player2SetupContainer.classList.add('hidden');
                } else {
                    player2SetupContainer.classList.remove('hidden');
                }
            });

            startGameBtn.addEventListener('click', () => {
                state.numPlayers = parseInt(numPlayersSelect.value);
                player1NameInput.value = player1SetupName.value;
                if (state.numPlayers === 2) {
                    player2NameInput.value = player2SetupName.value;
                }

                setupModal.classList.add('hidden');
                appContent.classList.remove('hidden');
                initializeGame(); // Inicializa el juego con los nuevos settings
            });

            // Sumar punto Jugador 1
            function handleAddPoint1() {
                saveState();
                state.score1++; // Suma al total
                state.inningScore1++; // Suma a la entrada
                // El jugador sigue activo
                state.currentPlayer = 1;
                if (state.innings === 0) { // Si es el primer punto, la entrada es 1
                    state.innings = 1;
                }
                startTimer();
                updateDisplay();
            }
            addPoint1Btn.addEventListener('click', handleAddPoint1);
            score1Display.addEventListener('click', handleAddPoint1); // Clic en el número también suma

            // Sumar punto Jugador 2
            function handleAddPoint2() {
                if (state.numPlayers === 1) return; // No hacer nada si es 1 jugador
                saveState();
                state.score2++; // Suma al total
                state.inningScore2++; // Suma a la entrada
                // El jugador sigue activo
                state.currentPlayer = 2;
                if (state.innings === 0) { // Si es el primer punto, la entrada es 1
                    state.innings = 1;
                }
                startTimer();
                updateDisplay();
            }
            addPoint2Btn.addEventListener('click', handleAddPoint2);
            score2Display.addEventListener('click', handleAddPoint2); // Clic en el número también suma

            // Deshacer punto Jugador 1 (Solo si tiene puntos)
            undoPoint1Btn.addEventListener('click', () => {
                // MODIFICACIÓN: Debe tener puntos en el total Y en la entrada para deshacer
                if (state.score1 > 0 && state.inningScore1 > 0) {
                    saveState();
                    state.score1--;
                    state.inningScore1--;
                    updateDisplay();
                }
            });

            // Deshacer punto Jugador 2 (Solo si tiene puntos)
            undoPoint2Btn.addEventListener('click', () => {
                if (state.numPlayers === 1) return;
                // MODIFICACIÓN: Debe tener puntos en el total Y en la entrada para deshacer
                if (state.score2 > 0 && state.inningScore2 > 0) {
                    saveState();
                    state.score2--;
                    state.inningScore2--;
                    updateDisplay();
                }
            });

            // Siguiente turno / Fallo
            nextInningBtn.addEventListener('click', () => {
                saveState();
                
                // MODIFICACIÓN: Reiniciar marcadores de entrada
                state.inningScore1 = 0;
                state.inningScore2 = 0;
                
                if (state.numPlayers === 1) {
                    state.innings++;
                } else {
                    if (state.currentPlayer === 1) {
                        state.currentPlayer = 2; // Turno del jugador 2
                    } else {
                        state.currentPlayer = 1; // Turno del jugador 1
                        state.innings++; // Incrementa la entrada cuando J2 termina su turno
                    }
                }
                if (state.innings === 0) { // Asegura que la entrada se incremente al menos a 1
                    state.innings = 1;
                }
                startTimer();
                updateDisplay();
            });

            // Deshacer última acción (general)
            undoBtn.addEventListener('click', () => {
                if (history.length > 0) {
                    // Si el estado a restaurar no tiene timerInterval (después de un reset, por ejemplo),
                    // asegurarnos de que el timer se detenga.
                    const lastState = history.pop();
                    if (!lastState.timerInterval) {
                        stopTimer();
                    }
                    state = lastState; // Restaura el estado completo
                    if (state.startTime) { // Reinicia el timer si había un tiempo registrado
                        startTimer();
                    } else {
                        stopTimer(); // Si no hay startTime, asegúrate de que esté parado
                        timerDisplay.textContent = '00:00:00';
                    }
                    updateDisplay();
                }
            });

            // NUEVO MANEJADOR DE PAUSA
            pauseTimerBtn.addEventListener('click', () => {
                if (!state.startTime) return; // No se puede pausar si no ha empezado

                if (state.isPaused) {
                    // Reanudar
                    state.isPaused = false;
                    // Sumar el tiempo que estuvo pausado
                    if (state.pauseStartTime) {
                        state.pausedTime += (Date.now() - state.pauseStartTime);
                    }
                    state.pauseStartTime = null;
                    // updateDisplay() se encargará de cambiar el texto del botón
                } else {
                    // Pausar
                    state.isPaused = true;
                    state.pauseStartTime = Date.now(); // Guardar el momento de la pausa
                    // updateDisplay() se encargará de cambiar el texto del botón
                }
                updateDisplay(); // Llama a updateDisplay para cambiar el botón
            });
 
            // Terminar partida
            finishGameBtn.addEventListener('click', () => {
                // Pausar el juego si no lo está, para "congelar" el tiempo de cálculo
                if (!state.isPaused && state.startTime) {
                    state.isPaused = true;
                    state.pauseStartTime = Date.now();
                    // No cambiar el botón, solo pausar internamente
                }
 
                let durationSeconds = 0;
                if (state.startTime) {
                    let elapsedMs = 0;
                    if (state.pauseStartTime) { // Si se ha pausado al menos una vez
                        // El tiempo total jugado es el momento en que se pausó, menos el inicio, menos el tiempo de pausa acumulado
                        elapsedMs = (state.pauseStartTime - state.startTime) - state.pausedTime;
                    } else if (state.startTime) { // Si nunca se pausó
                        elapsedMs = Date.now() - state.startTime;
                    } else { // Si no ha empezado
                        elapsedMs = 0;
                    }
                    durationSeconds = Math.floor(elapsedMs / 1000);
                    if (durationSeconds < 0) durationSeconds = 0; // Seguridad
                }
                
                const durationFormatted = formatTime(durationSeconds);
 
                // Calcular promedios finales
                let finalP1Innings = state.innings;
                let finalP2Innings = state.innings;

                if (state.innings === 0) { // Si no se jugó nada
                    finalP1Innings = 1;
                    finalP2Innings = 1;
                } else if (state.numPlayers === 2) {
                    // Si la partida terminó con el turno del J1 activo, el J2 tiene una entrada menos completada
                    if (state.currentPlayer === 1 && state.innings > 0) {
                        finalP2Innings = state.innings - 1;
                    }
                }

                const finalAvg1 = calculateAvg(state.score1, finalP1Innings > 0 ? finalP1Innings : 1);
                const finalAvg2 = calculateAvg(state.score2, finalP2Innings > 0 ? finalP2Innings : 1);


                let resultsHtml = `
                    <h4 class="text-xl font-bold text-yellow-400 mb-4">Resultados de la Partida:</h4>
                    <p><strong>Duración:</strong> ${durationFormatted}</p>
                    <p><strong>Entradas Totales:</strong> ${state.innings}</p>
                    <hr class="my-3 border-gray-600">
                    <p><strong>${player1NameInput.value}:</strong></p>
                    <ul>
                        <li>Carambolas: ${state.score1}</li>
                        <li>Promedio: ${finalAvg1}</li>
                    </ul>
                `;

                if (state.numPlayers === 2) {
                    resultsHtml += `
                        <hr class="my-3 border-gray-600">
                        <p><strong>${player2NameInput.value}:</strong></p>
                        <ul>
                            <li>Carambolas: ${state.score2}</li>
                            <li>Promedio: ${finalAvg2}</li>
                        </ul>
                    `;
                }
                
                showConfirmation('Partida Terminada', '', null, true, resultsHtml);
            });


            // Resetear partida (MODIFICADO para volver al setup)
            resetBtn.addEventListener('click', () => {
                showConfirmation(
                    'Reiniciar Aplicación', // Título cambiado
                    '¿Estás seguro de que quieres salir? Volverás a la pantalla de configuración.', // Mensaje cambiado
                    () => {
                        stopTimer(); // Detener cualquier reloj
                        
                        // Ocultar la app, mostrar el setup
                        appContent.classList.add('hidden');
                        setupModal.classList.remove('hidden');

                        // Ocultar el modal de confirmación
                        hideConfirmation();
                    }
                );
            });
 
            // Eventos del Modal de confirmación (si no es de resultados)
            modalCancelBtn.addEventListener('click', hideConfirmation);
            modalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
            });

            /**
             * Inicializa el estado del juego y la UI.
             */
            function initializeGame() {
                stopTimer(); // Asegurarse de que el timer esté parado antes de resetear
                state = {
                    score1: 0,
                    score2: 0,
                    inningScore1: 0, // MODIFICACIÓN
                    inningScore2: 0, // MODIFICACIÓN
                    innings: 0,
                    currentPlayer: 1,
                    startTime: null,
                    timerInterval: null,
                    numPlayers: state.numPlayers, // Mantiene el número de jugadores configurado
                    // RESETEAR NUEVO ESTADO
                    isPaused: false,
                    pausedTime: 0,
                    pauseStartTime: null
                };
                history = []; // Limpiar historial al reiniciar
                timerDisplay.textContent = '00:00:00';
                updateDisplay();
            }

            // --- INICIALIZACIÓN AL CARGAR LA PÁGINA ---
            // El modal de setup se muestra primero.
            // La inicialización del juego se hace después de que el usuario configure.
            // updateDisplay(); // No es necesario al inicio ya que el modal lo cubre.
        });
    </script>
</body>
</html>