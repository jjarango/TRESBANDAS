<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Marcador de Billar 3 Bandas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
            overflow: hidden;
        }

        /* Inputs */
        input[type="text"], input[type="number"], select {
            -webkit-user-select: text;
            user-select: text;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Paneles */
        .player-active {
            box-shadow: inset 0 0 0 4px #FACC15;
        }
        .player-active-bg {
            background-color: #7f1d1d;
        }
        .player-inactive-bg {
            background-color: #1f2937; /* Gris oscuro */
        }

        /* Texto Score Central */
        .text-score {
            font-size: 7rem;
            line-height: 1;
        }
        @media (max-width: 768px) {
            .text-score {
                font-size: 5rem;
            }
        }

        /* Reloj */
        .shot-clock-bar-container { display: flex; height: 100%; width: 100%; gap: 2px; }
        .clock-segment { flex: 1; height: 35px; background-color: #374151; border-radius: 2px; }
        .segment-green { background-color: #22c55e; box-shadow: 0 0 4px #22c55e; }
        .segment-orange { background-color: #f97316; box-shadow: 0 0 4px #f97316; }
        .segment-red { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        
        /* Banderas */
        .flag-icon {
            display: block;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-2 fixed w-full h-full inset-0"> 

    <div id="setup-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full border border-gray-600">
            <h3 class="text-2xl font-bold mb-4 text-yellow-400 text-center">Configuración</h3>
            
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-1">Modo:</label>
                <select id="num-players" class="w-full p-2 bg-gray-700 text-white rounded focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="1">1 Jugador</option>
                    <option value="2" selected>2 Jugadores</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-1">Timer:</label>
                <select id="regulatory-timer" class="w-full p-2 bg-gray-700 text-white rounded focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="yes" selected>Reglamentario (40s)</option>
                    <option value="no">Libre</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-1">Jugador 1:</label>
                <div class="flex gap-2">
                    <input type="text" id="player1-setup-name" maxlength="12" value="Jugador 1" class="flex-1 p-2 bg-gray-700 text-white rounded focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <select id="player1-country" class="w-32 p-2 bg-gray-700 text-white rounded text-sm"></select>
                </div>
            </div>

            <div id="player2-setup-container" class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-1">Jugador 2:</label>
                <div class="flex gap-2">
                    <input type="text" id="player2-setup-name" maxlength="12" value="Jugador 2" class="flex-1 p-2 bg-gray-700 text-white rounded focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <select id="player2-country" class="w-32 p-2 bg-gray-700 text-white rounded text-sm"></select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-yellow-500 text-sm font-bold mb-1">Carambolas:</label>
                    <input type="number" id="setup-target-score" value="40" class="w-full p-2 bg-gray-700 text-white text-center font-bold text-lg rounded focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <div>
                    <label class="block text-blue-400 text-sm font-bold mb-1">Entradas:</label>
                    <input type="number" id="setup-target-innings" value="50" class="w-full p-2 bg-gray-700 text-white text-center font-bold text-lg rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <button id="start-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded text-lg shadow-lg transition">
                JUGAR
            </button>
        </div>
    </div>

    <div id="app-content" class="w-full h-full flex flex-col hidden">
        
        <header class="bg-black/30 p-2 shrink-0 border-b border-gray-700">
            <div class="flex items-center justify-between gap-3 mb-1 px-1">
                <div id="shot-clock-wrapper" class="flex-1 flex items-center gap-2 bg-black border border-gray-600 rounded px-2 py-1 max-w-3xl mx-auto">
                    <button id="init-timer-btn" class="w-8 h-8 flex items-center justify-center bg-gray-800 text-green-500 rounded font-bold border border-gray-600">I</button>
                    <div id="shot-clock-number" class="text-4xl font-mono font-bold text-white w-16 text-center leading-none">40</div>
                    <div id="shot-clock-bars" class="shot-clock-bar-container flex-1"></div>
                </div>
                
                <div class="hidden sm:block text-right w-24">
                    <div id="timer-display" class="text-xl font-mono text-gray-300">00:00:00</div>
                </div>
            </div>

            <div class="flex justify-between items-end px-4 text-gray-400 text-xs font-bold uppercase">
                <div>Meta: <span id="distancia-display" class="text-yellow-400 text-base">40</span></div>
                <div class="sm:hidden"><span id="timer-display-mobile" class="font-mono text-white">00:00:00</span></div>
                <div>Límite: <span id="limit-display" class="text-blue-400 text-base">50</span></div>
            </div>
        </header>

        <div class="bg-gray-800 border-b border-gray-700 p-2 shrink-0 flex items-center justify-center shadow-md z-20">
            <div class="text-center">
                <span class="text-gray-400 text-sm font-bold uppercase tracking-widest mr-2">ENTRADA:</span>
                <span id="innings-display" class="text-5xl font-black text-white leading-none align-middle">1</span>
            </div>
        </div>

        <main class="flex flex-1 overflow-hidden relative">
            
            <div id="player1-panel" class="relative w-1/2 flex flex-col border-r border-gray-700 transition-colors duration-200 player-inactive-bg">
                
                <div class="absolute top-3 left-3 z-10 flex flex-col items-start max-w-[65%]">
                    <input type="text" id="player1-name" value="Jugador 1" readonly class="bg-transparent text-white font-bold text-2xl sm:text-3xl text-left w-full outline-none p-0 m-0 truncate">
                    <img id="player1-flag-display" src="" class="flag-icon h-6 w-auto mt-1 border border-white/20" alt="Flag">
                </div>

                <div class="absolute top-3 right-3 z-10 bg-black/80 border border-gray-500 rounded-lg p-1 text-center w-24 shadow-lg">
                    <span class="block text-[10px] text-gray-400 font-bold uppercase">Total</span>
                    <span id="total-score-box-1" class="text-6xl font-black text-white leading-none">0</span>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center cursor-pointer select-none touch-manipulation hover:bg-white/5 pt-16" id="touch-area-1">
                    <div id="score1-display" class="text-score font-black text-yellow-400 leading-none drop-shadow-lg">0</div>
                    <div class="mt-2 text-gray-400 font-bold text-2xl">
                        <span id="avg1-display">0.000</span>
                    </div>
                </div>

                <div class="p-2 flex gap-2 mt-auto bg-black/20 border-t border-white/5">
                    <button id="add-point-1" class="flex-1 bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded text-2xl shadow active:scale-95 transition">+1</button>
                    <button id="undo-point-1" class="w-20 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded text-2xl shadow active:scale-95 transition">↩</button>
                </div>
            </div>
            
            <div id="player2-panel" class="relative w-1/2 flex flex-col transition-colors duration-200 player-inactive-bg">
                
                <div class="absolute top-3 left-3 z-10 flex flex-col items-start max-w-[65%]">
                    <input type="text" id="player2-name" value="Jugador 2" readonly class="bg-transparent text-white font-bold text-2xl sm:text-3xl text-left w-full outline-none p-0 m-0 truncate">
                    <img id="player2-flag-display" src="" class="flag-icon h-6 w-auto mt-1 border border-white/20" alt="Flag">
                </div>

                <div class="absolute top-3 right-3 z-10 bg-black/80 border border-gray-500 rounded-lg p-1 text-center w-24 shadow-lg">
                    <span class="block text-[10px] text-gray-400 font-bold uppercase">Total</span>
                    <span id="total-score-box-2" class="text-6xl font-black text-white leading-none">0</span>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center cursor-pointer select-none touch-manipulation hover:bg-white/5 pt-16" id="touch-area-2">
                    <div id="score2-display" class="text-score font-black text-yellow-400 leading-none drop-shadow-lg">0</div>
                    <div class="mt-2 text-gray-400 font-bold text-2xl">
                        <span id="avg2-display">0.000</span>
                    </div>
                </div>

                <div class="p-2 flex gap-2 mt-auto bg-black/20 border-t border-white/5">
                    <button id="add-point-2" class="flex-1 bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded text-2xl shadow active:scale-95 transition">+1</button>
                    <button id="undo-point-2" class="w-20 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded text-2xl shadow active:scale-95 transition">↩</button>
                </div>
            </div>

        </main>

        <footer class="bg-gray-900 p-2 shrink-0 border-t border-gray-700 flex gap-2 overflow-x-auto">
            <button id="next-inning-btn" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white font-bold py-3 px-2 rounded-lg text-lg leading-tight shadow active:scale-95 transition min-w-[100px] whitespace-normal">
                CAMBIO TURNO / FALLO
            </button>
            
            <button id="undo-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow active:scale-95 transition">Deshacer</button>
            <button id="pause-timer-btn" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow active:scale-95 transition">Pausa</button>
            <button id="finish-game-btn" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow active:scale-95 transition">Fin</button>
            <button id="reset-btn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow active:scale-95 transition">Salir</button>
        </footer>

    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-gray-600">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white">Confirmación</h3>
            <div id="modal-content" class="text-gray-300 mb-6"></div>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 text-white font-bold">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white font-bold">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) { }
            lastTouchEnd = now;
        }, false);

        document.addEventListener('DOMContentLoaded', () => {
            const countries = [
                { name: "Alemania", code: "de" }, { name: "Argentina", code: "ar" }, { name: "Austria", code: "at" }, { name: "Bélgica", code: "be" },
                { name: "Bolivia", code: "bo" }, { name: "Brasil", code: "br" }, { name: "Canadá", code: "ca" }, { name: "Chile", code: "cl" },
                { name: "China", code: "cn" }, { name: "Colombia", code: "co" }, { name: "Corea del Sur", code: "kr" }, { name: "Costa Rica", code: "cr" },
                { name: "Dinamarca", code: "dk" }, { name: "Ecuador", code: "ec" }, { name: "Egipto", code: "eg" }, { name: "España", code: "es" },
                { name: "Estados Unidos", code: "us" }, { name: "Filipinas", code: "ph" }, { name: "Francia", code: "fr" }, { name: "Gran Bretaña", code: "gb" },
                { name: "Grecia", code: "gr" }, { name: "Holanda", code: "nl" }, { name: "Italia", code: "it" }, { name: "Japón", code: "jp" },
                { name: "México", code: "mx" }, { name: "Nicaragua", code: "ni" }, { name: "Panamá", code: "pa" }, { name: "Paraguay", code: "py" },
                { name: "Perú", code: "pe" }, { name: "Portugal", code: "pt" }, { name: "Suecia", code: "se" }, { name: "Suiza", code: "ch" },
                { name: "Turquía", code: "tr" }, { name: "Uruguay", code: "uy" }, { name: "Venezuela", code: "ve" }, { name: "Vietnam", code: "vn" },
                { name: "Mundo / Otro", code: "un" }
            ];

            const populateCountrySelects = () => {
                ['player1-country', 'player2-country'].forEach((id, index) => {
                    const select = document.getElementById(id);
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.code;
                        option.textContent = country.name;
                        if (index === 0 && country.code === "co") option.selected = true;
                        if (index === 1 && country.code === "us") option.selected = true;
                        select.appendChild(option);
                    });
                });
            };
            populateCountrySelects();

            // Lógica para ocultar/mostrar Jugador 2
            const numPlayersSelect = document.getElementById('num-players');
            const p2SetupContainer = document.getElementById('player2-setup-container');
            
            function toggleP2Setup() {
                if(numPlayersSelect.value === '1') {
                    p2SetupContainer.classList.add('hidden');
                } else {
                    p2SetupContainer.classList.remove('hidden');
                }
            }
            numPlayersSelect.addEventListener('change', toggleP2Setup);
            toggleP2Setup(); // Ejecutar al inicio

            let state = {
                score1: 0, score2: 0, inningScore1: 0, inningScore2: 0, innings: 0, currentPlayer: 1, 
                startTime: null, timerInterval: null, numPlayers: 2, regulatoryTimer: true, 
                isPaused: false, pausedTime: 0, pauseStartTime: null, targetScore: 40, targetInnings: 50,
                player1Flag: "co", player2Flag: "us", highRun1: 0, highRun2: 0, zeros1: 0, zeros2: 0,
                shotClockTime: 0, shotClockInterval: null
            };
            let history = [];
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            const els = {
                app: document.getElementById('app-content'), setup: document.getElementById('setup-modal'),
                p1Name: document.getElementById('player1-name'), p2Name: document.getElementById('player2-name'),
                p1Panel: document.getElementById('player1-panel'), p2Panel: document.getElementById('player2-panel'),
                score1: document.getElementById('score1-display'), score2: document.getElementById('score2-display'),
                total1: document.getElementById('total-score-box-1'), total2: document.getElementById('total-score-box-2'),
                avg1: document.getElementById('avg1-display'), avg2: document.getElementById('avg2-display'),
                innings: document.getElementById('innings-display'), timer: document.getElementById('timer-display'),
                timerMobile: document.getElementById('timer-display-mobile'), shotNum: document.getElementById('shot-clock-number'),
                shotBars: document.getElementById('shot-clock-bars'), p1Flag: document.getElementById('player1-flag-display'),
                p2Flag: document.getElementById('player2-flag-display'), metaDist: document.getElementById('distancia-display'),
                metaLimit: document.getElementById('limit-display')
            };

            function getFlagUrl(code) { return `https://flagcdn.com/w80/${code}.png`; }
            function formatTime(s) {
                const h = String(Math.floor(s/3600)).padStart(2,'0'), m = String(Math.floor((s%3600)/60)).padStart(2,'0'), sec = String(s%60).padStart(2,'0');
                return `${h}:${m}:${sec}`;
            }
            function calcAvg(s, i) { return i <= 0 ? '0.000' : (s/i).toFixed(3); }
            function playAlarm() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.type = 'sawtooth'; o.frequency.setValueAtTime(440, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.5);
                g.gain.setValueAtTime(0.5, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + 0.5);
            }

            els.shotBars.innerHTML = '';
            for(let i=0; i<40; i++) {
                const d = document.createElement('div'); d.className = 'clock-segment'; d.id = `seg-${i}`;
                els.shotBars.appendChild(d);
            }

            function updateShotVisual(t) {
                const isOver = t > 40;
                const barIndex = t - 1;
                if (isOver) {
                    document.querySelectorAll('.clock-segment').forEach(b => {
                        b.classList.remove('segment-green', 'segment-orange'); b.classList.add('segment-red');
                    });
                    return;
                }
                const bar = document.getElementById(`seg-${barIndex}`);
                if (bar) {
                    if (t <= 20) bar.classList.add('segment-green');
                    else if (t <= 30) bar.classList.add('segment-orange');
                    else bar.classList.add('segment-red');
                }
            }

            function runTimer() {
                if (state.timerInterval) return;
                state.timerInterval = setInterval(() => {
                    if (state.isPaused) return;
                    const e = Math.floor((Date.now() - state.startTime - state.pausedTime) / 1000);
                    const txt = formatTime(e);
                    els.timer.textContent = txt; els.timerMobile.textContent = txt;
                }, 1000);
            }

            function runShotClock() {
                clearInterval(state.shotClockInterval);
                state.shotClockInterval = setInterval(() => {
                    if (state.isPaused) return;
                    state.shotClockTime++;
                    if (state.regulatoryTimer) {
                        els.shotNum.textContent = 40 - state.shotClockTime;
                        if (state.shotClockTime >= 55) { playAlarm(); resetShot(); return; }
                    } else {
                        els.shotNum.textContent = state.shotClockTime;
                    }
                    updateShotVisual(state.shotClockTime);
                }, 1000);
            }

            function resetShot() {
                clearInterval(state.shotClockInterval);
                state.shotClockTime = 0;
                els.shotNum.textContent = state.regulatoryTimer ? "40" : "0";
                document.querySelectorAll('.clock-segment').forEach(b => b.className = 'clock-segment');
                runShotClock();
            }

            function updateUI() {
                // Actualizar nombres desde inputs de setup
                els.p1Name.value = document.getElementById('player1-setup-name').value;
                els.p2Name.value = document.getElementById('player2-setup-name').value;

                els.p1Flag.src = getFlagUrl(state.player1Flag);
                els.p2Flag.src = getFlagUrl(state.player2Flag);

                els.score1.textContent = state.inningScore1; els.score2.textContent = state.inningScore2;
                els.total1.textContent = state.score1; els.total2.textContent = state.score2;

                els.p1Panel.classList.remove('player-active', 'player-active-bg', 'player-inactive-bg');
                els.p2Panel.classList.remove('player-active', 'player-active-bg', 'player-inactive-bg');

                if (state.currentPlayer === 1) {
                    els.p1Panel.classList.add('player-active', 'player-active-bg');
                    els.p2Panel.classList.add('player-inactive-bg');
                } else if (state.numPlayers === 2) {
                    els.p2Panel.classList.add('player-active', 'player-active-bg');
                    els.p1Panel.classList.add('player-inactive-bg');
                }

                if (state.numPlayers === 1) {
                    els.p2Panel.classList.add('hidden');
                    els.p1Panel.classList.remove('w-1/2'); els.p1Panel.classList.add('w-full', 'border-r-0');
                } else {
                    els.p2Panel.classList.remove('hidden');
                    els.p1Panel.classList.remove('w-full', 'border-r-0'); els.p1Panel.classList.add('w-1/2', 'border-r');
                }

                const currentInn = state.innings + 1;
                els.innings.textContent = currentInn;

                let div1 = currentInn, div2 = (state.numPlayers===2 && state.currentPlayer===2) ? currentInn : state.innings;
                if(div2===0) div2=1;

                els.avg1.textContent = calcAvg(state.score1, div1);
                els.avg2.textContent = calcAvg(state.score2, div2);

                const pBtn = document.getElementById('pause-timer-btn');
                pBtn.textContent = state.isPaused ? "Reanudar" : "Pausa";
                pBtn.className = state.isPaused ? "bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow active:scale-95 transition" : "bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow active:scale-95 transition";
            }

            function finishGame(reason) {
                if(!state.isPaused) { state.isPaused = true; state.pauseStartTime = Date.now(); }
                clearInterval(state.shotClockInterval);
                
                let p1d = state.innings + (state.currentPlayer===1?1:0);
                if(state.currentPlayer===2) p1d = state.innings + 1;
                let p2d = state.innings + (state.currentPlayer===2?1:0);
                
                if(state.targetInnings>0 && state.innings >= state.targetInnings) { p1d = state.innings; p2d = state.innings; }
                if(p1d===0) p1d=1; if(p2d===0) p2d=1;

                const tSeconds = Math.floor(((state.pauseStartTime||Date.now()) - state.startTime - state.pausedTime)/1000);
                
                const modal = document.getElementById('confirmation-modal');
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').textContent = "Partida Finalizada";
                let html = `
                    <div class="text-center mb-4 text-yellow-400 font-bold border-b border-gray-600 pb-2">${reason||""}</div>
                    <div class="flex justify-between text-sm mb-4"><span>⏱ ${formatTime(tSeconds)}</span><span>Entradas: ${Math.max(p1d, p2d)}</span></div>
                    <div class="bg-black/30 p-3 rounded mb-2">
                        <div class="flex items-center gap-2 mb-1"><img src="${getFlagUrl(state.player1Flag)}" class="h-4"><strong class="text-yellow-200">${els.p1Name.value}</strong></div>
                        <div class="grid grid-cols-2 text-sm gap-y-1"><span>Car: <b>${state.score1}</b></span><span>Prom: <b>${calcAvg(state.score1, p1d)}</b></span><span>Mayor: <b>${state.highRun1}</b></span><span>Ceros: <b>${state.zeros1}</b></span></div>
                    </div>
                `;
                if(state.numPlayers===2){
                    html += `<div class="bg-black/30 p-3 rounded">
                        <div class="flex items-center gap-2 mb-1"><img src="${getFlagUrl(state.player2Flag)}" class="h-4"><strong class="text-yellow-200">${els.p2Name.value}</strong></div>
                        <div class="grid grid-cols-2 text-sm gap-y-1"><span>Car: <b>${state.score2}</b></span><span>Prom: <b>${calcAvg(state.score2, p2d)}</b></span><span>Mayor: <b>${state.highRun2}</b></span><span>Ceros: <b>${state.zeros2}</b></span></div>
                    </div>`;
                }
                content.innerHTML = html;
                document.getElementById('modal-cancel-btn').style.display = 'none';
                document.getElementById('modal-confirm-btn').textContent = "Cerrar";
                document.getElementById('modal-confirm-btn').onclick = () => { modal.classList.add('hidden'); };
                modal.classList.remove('hidden');
            }

            function addPoint(p) {
                const prev = JSON.parse(JSON.stringify(state)); prev.timerInterval=null; prev.shotClockInterval=null;
                if(history.length>50) history.shift(); history.push(prev);

                if(p===1) {
                    state.score1++; state.inningScore1++; state.currentPlayer=1;
                    if(state.inningScore1 > state.highRun1) state.highRun1 = state.inningScore1;
                    if(state.targetScore>0 && state.score1>=state.targetScore) setTimeout(()=>finishGame("¡Meta Alcanzada!"),100);
                } else {
                    state.score2++; state.inningScore2++; state.currentPlayer=2;
                    if(state.inningScore2 > state.highRun2) state.highRun2 = state.inningScore2;
                    if(state.targetScore>0 && state.score2>=state.targetScore) setTimeout(()=>finishGame("¡Meta Alcanzada!"),100);
                }
                runTimer(); updateUI();
            }

            function nextInning() {
                const prev = JSON.parse(JSON.stringify(state)); prev.timerInterval=null; prev.shotClockInterval=null;
                if(history.length>50) history.shift(); history.push(prev);

                if(state.currentPlayer===1) { if(state.inningScore1===0) state.zeros1++; }
                else { if(state.inningScore2===0) state.zeros2++; }

                state.inningScore1 = 0; state.inningScore2 = 0;

                if(state.numPlayers===1) { state.innings++; } 
                else { if(state.currentPlayer===1) state.currentPlayer=2; else { state.currentPlayer=1; state.innings++; } }

                runTimer(); resetShot(); updateUI();
                if(state.targetInnings>0 && state.innings>=state.targetInnings) setTimeout(()=>finishGame("Límite de Entradas"),100);
            }

            document.getElementById('start-game-btn').onclick = () => {
                state.numPlayers = parseInt(document.getElementById('num-players').value);
                state.regulatoryTimer = (document.getElementById('regulatory-timer').value === 'yes');
                state.player1Flag = document.getElementById('player1-country').value;
                state.player2Flag = document.getElementById('player2-country').value;
                state.targetScore = parseInt(document.getElementById('setup-target-score').value) || 0;
                state.targetInnings = parseInt(document.getElementById('setup-target-innings').value) || 0;
                
                els.metaDist.textContent = state.targetScore > 0 ? state.targetScore : "∞";
                els.metaLimit.textContent = state.targetInnings > 0 ? state.targetInnings : "∞";

                els.setup.classList.add('hidden'); els.app.classList.remove('hidden');
                if(audioCtx.state === 'suspended') audioCtx.resume();
                
                state.startTime = Date.now();
                runTimer(); resetShot(); updateUI();
            };

            document.getElementById('touch-area-1').onclick = () => addPoint(1);
            document.getElementById('add-point-1').onclick = () => addPoint(1);
            document.getElementById('touch-area-2').onclick = () => { if(state.numPlayers===2) addPoint(2); };
            document.getElementById('add-point-2').onclick = () => { if(state.numPlayers===2) addPoint(2); };
            document.getElementById('next-inning-btn').onclick = nextInning;
            document.getElementById('init-timer-btn').onclick = resetShot;
            document.getElementById('finish-game-btn').onclick = () => finishGame("Finalizado Manualmente");
            
            document.getElementById('undo-point-1').onclick = () => {
               if(state.score1>0 && state.inningScore1>0) {
                   const prev = JSON.parse(JSON.stringify(state)); if(history.length>50) history.shift(); history.push(prev);
                   state.score1--; state.inningScore1--; updateUI();
               }
            };
            document.getElementById('undo-point-2').onclick = () => {
               if(state.numPlayers===2 && state.score2>0 && state.inningScore2>0) {
                   const prev = JSON.parse(JSON.stringify(state)); if(history.length>50) history.shift(); history.push(prev);
                   state.score2--; state.inningScore2--; updateUI();
               }
            };
            document.getElementById('undo-btn').onclick = () => {
                if(history.length>0) { const h = history.pop(); Object.assign(state, h); state.isPaused = false; runTimer(); updateUI(); }
            };
            document.getElementById('pause-timer-btn').onclick = () => {
                if(!state.startTime) return;
                state.isPaused = !state.isPaused;
                if(state.isPaused) state.pauseStartTime = Date.now(); else { state.pausedTime += (Date.now() - state.pauseStartTime); state.pauseStartTime = null; }
                updateUI();
            };
            document.getElementById('reset-btn').onclick = () => {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('modal-title').textContent = "¿Salir?";
                document.getElementById('modal-content').innerHTML = "Perderás el progreso actual.";
                document.getElementById('modal-cancel-btn').style.display = 'block';
                document.getElementById('modal-confirm-btn').textContent = "Confirmar";
                document.getElementById('modal-confirm-btn').onclick = () => {
                    clearInterval(state.shotClockInterval); clearInterval(state.timerInterval);
                    els.app.classList.add('hidden'); els.setup.classList.remove('hidden'); modal.classList.add('hidden');
                    state = {
                        score1: 0, score2: 0, inningScore1: 0, inningScore2: 0, innings: 0, currentPlayer: 1, 
                        startTime: null, timerInterval: null, numPlayers: state.numPlayers, regulatoryTimer: state.regulatoryTimer, 
                        isPaused: false, pausedTime: 0, pauseStartTime: null, targetScore: 40, targetInnings: 50,
                        player1Flag: state.player1Flag, player2Flag: state.player2Flag, highRun1: 0, highRun2: 0, zeros1: 0, zeros2: 0,
                        shotClockTime: 0, shotClockInterval: null
                    };
                    history = []; els.timer.textContent = "00:00:00";
                };
                modal.classList.remove('hidden');
                document.getElementById('modal-cancel-btn').onclick = () => modal.classList.add('hidden');
            };
        });
    </script>
</body>
</html>