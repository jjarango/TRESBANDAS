<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador de Billar (Estilo Kozoom)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Estilo personalizado para la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Evitar que los inputs de número muestren flechas */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Resaltado del jugador activo */
        .player-active {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.7); /* Sombra brillante amarilla */
            border-color: #FACC15; /* Amarillo de Tailwind */
        }
        /* Estilo para el fondo del jugador activo */
        .player-active-bg {
            background-color: #6a0f13;
        }
        /* Estilos para el texto grande y responsive */
        .text-score {
            font-size: 6rem;
        }
        @media (max-width: 768px) {
            .text-score {
                font-size: 4.5rem;
            }
        }
        @media (max-width: 640px) {
            .text-score {
                font-size: 3.5rem;
            }
        }
        .text-innings {
            font-size: 4rem;
        }
        @media (max-width: 768px) {
            .text-innings {
                font-size: 3rem;
            }
        }

        /* --- ESTILOS DEL SHOT CLOCK --- */
        .shot-clock-bar-container {
            display: flex;
            align-items: center;
            height: 100%;
            width: 100%;
            gap: 2px;
        }
        .clock-segment {
            flex: 1;
            height: 40px;
            background-color: #1f2937; /* Gris oscuro apagado */
            border-radius: 2px;
            transition: background-color 0.1s linear;
        }
        /* Colores activos */
        .segment-green { background-color: #22c55e; box-shadow: 0 0 4px #22c55e; }
        .segment-orange { background-color: #f97316; box-shadow: 0 0 4px #f97316; }
        .segment-red { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        
        /* Animación parpadeo para overtime */
        @keyframes flash-red {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #7f1d1d; }
        }
        .segment-alarm {
            animation: flash-red 0.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-2 sm:p-4">

    <div id="setup-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full max-h-screen overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-yellow-400 text-center">Configurar Partida</h3>
            
            <div class="mb-4">
                <label for="num-players" class="block text-gray-300 text-sm font-semibold mb-1">Número de jugadores:</label>
                <select id="num-players" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <option value="1">1 Jugador</option>
                    <option value="2" selected>2 Jugadores</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="player1-setup-name" class="block text-gray-300 text-sm font-semibold mb-1">Nombre J1:</label>
                    <input type="text" id="player1-setup-name" value="Jugador 1" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <div id="player2-setup-container">
                    <label for="player2-setup-name" class="block text-gray-300 text-sm font-semibold mb-1">Nombre J2:</label>
                    <input type="text" id="player2-setup-name" value="Jugador 2" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
            </div>

            <hr class="border-gray-600 my-4">

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="setup-target-score" class="block text-yellow-200 text-sm font-semibold mb-1">Carambolas (Meta):</label>
                    <input type="number" id="setup-target-score" value="30" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-md text-center font-bold text-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>
                <div>
                    <label for="setup-target-innings" class="block text-blue-200 text-sm font-semibold mb-1">Entradas (Límite):</label>
                    <input type="number" id="setup-target-innings" value="40" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-md text-center font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <button id="start-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-200">
                Empezar Partida
            </button>
        </div>
    </div>

    <div id="app-content" class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden hidden">
        
        <header class="bg-black/20 p-3 sm:p-4 text-center border-b border-gray-700">
            <h1 class="text-2xl sm:text-3xl font-bold text-yellow-400 mb-2">Carambolas a 3 Bandas | jjarango</h1>
            
            <div id="shot-clock-wrapper" class="w-full max-w-4xl mx-auto mb-4 bg-black border-2 border-gray-700 rounded-lg p-2 flex items-center gap-3 shadow-lg">
                
                <button id="init-timer-btn" style="background-color: #183b06;" class="w-12 h-12 text-white font-bold text-xl rounded flex items-center justify-center hover:opacity-90 transition-opacity border border-gray-600" title="Iniciar Timer">
                    I
                </button>

                <div id="shot-clock-number" class="text-5xl sm:text-6xl font-mono font-bold text-white w-24 text-center leading-none">40</div>
                
                <div id="shot-clock-bars" class="shot-clock-bar-container flex-1">
                    </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-8">
                <div class="text-center">
                    <label for="distancia" class="text-sm text-gray-400">Carambolas pactadas:</label>
                    <input type="number" id="distancia" readonly class="w-16 sm:w-20 bg-gray-700 text-white text-center text-lg font-bold rounded p-1 focus:outline-none focus:ring-2 focus:ring-yellow-400 cursor-not-allowed opacity-80">
                </div>
                
                <div class="text-center flex-1">
                    <div id="timer-display" class="text-4xl sm:text-5xl font-black text-white">00:00:00</div>
                    <div class="text-sm sm:text-lg font-bold text-gray-400 tracking-wider">TIEMPO DE PARTIDA</div>
                </div>

                <div class="text-center">
                    <div class="text-4xl sm:text-5xl font-black text-white flex items-baseline justify-center">
                        <span id="innings-display">0</span>
                        <span id="innings-limit-display" class="text-2xl text-gray-500 ml-1 hidden">/ 40</span>
                    </div>
                    <div class="text-sm sm:text-lg font-bold text-gray-400 tracking-wider">ENTRADAS</div>
                </div>
            </div>
        </header>

        <div class="bg-gray-700/50 p-3 sm:p-4 text-center text-xl sm:text-2xl border-b border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center md:space-x-4">
                <div class="w-full md:w-2/5 text-center md:text-left mb-2 md:mb-0">
                    <span id="summary-name1" class="font-bold text-yellow-400">Jugador 1</span>: 
                    <span id="summary-score1" class="font-bold text-white">0</span>
                    (<span id="summary-avg1" class="text-gray-300 text-lg sm:text-xl">0.000</span>)
                </div>
                
                <div class="w-full md:w-1/5 text-center font-black text-white order-first md:order-none mb-2 md:mb-0">
                    Entrada: <span id="summary-innings">0</span>
                </div>

                <div id="summary-player2" class="w-full md:w-2/5 text-center md:text-right">
                    <span id="summary-name2" class="font-bold text-yellow-400">Jugador 2</span>: 
                    <span id="summary-score2" class="font-bold text-white">0</span>
                    (<span id="summary-avg2" class="text-gray-300 text-lg sm:text-xl">0.000</span>)
                </div>
            </div>
        </div>

        <main class="flex flex-col md:flex-row">
            
            <div id="player1-panel" class="relative w-full md:w-1/2 p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gray-700/50 border-t-4 border-transparent transition-all duration-300">
                
                <div class="absolute top-2 right-2 sm:top-4 sm:right-4 w-[35%] min-w-[110px] bg-black rounded-xl border-2 border-gray-600 shadow-xl flex flex-col items-center justify-center p-2 sm:p-3 z-20">
                    <span class="text-xs sm:text-sm text-gray-400 uppercase tracking-widest font-bold">Total</span>
                    <span id="total-score-box-1" class="text-3xl sm:text-5xl font-black text-white leading-none mt-1">0</span>
                </div>

                <input type="text" id="player1-name" value="Jugador 1" class="text-2xl sm:text-3xl font-bold bg-transparent text-white text-center rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3 sm:mb-4 pr-24 sm:pr-32">
                
                <div id="score1-display" class="text-score font-black text-yellow-400 my-4 sm:my-8 cursor-pointer relative" title="Clic para sumar 1 punto">
                    0
                    <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-yellow-600 font-bold uppercase tracking-widest whitespace-nowrap">Serie Actual</span>
                </div>
                
                <div class="text-xl sm:text-3xl font-bold text-white mb-4 sm:mb-6">
                    Promedio: <span id="avg1-display">0.000</span>
                </div>

                <div class="flex space-x-2 sm:space-x-3 w-full">
                    <button id="add-point-1" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                        +1 Carambola
                    </button>
                    <button id="undo-point-1" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-5 rounded-lg text-base sm:text-lg shadow-lg transition duration-200" title="Deshacer punto">
                        &#x21A9;
                    </button>
                </div>
            </div>
            
            <div id="player2-panel" class="relative w-full md:w-1/2 p-4 sm:p-6 md:p-8 flex flex-col items-center bg-gray-800/50 border-t-4 border-transparent transition-all duration-300 md:border-l border-gray-700">
                
                <div class="absolute top-2 right-2 sm:top-4 sm:right-4 w-[35%] min-w-[110px] bg-black rounded-xl border-2 border-gray-600 shadow-xl flex flex-col items-center justify-center p-2 sm:p-3 z-20">
                    <span class="text-xs sm:text-sm text-gray-400 uppercase tracking-widest font-bold">Total</span>
                    <span id="total-score-box-2" class="text-3xl sm:text-5xl font-black text-white leading-none mt-1">0</span>
                </div>

                <input type="text" id="player2-name" value="Jugador 2" class="text-2xl sm:text-3xl font-bold bg-transparent text-white text-center rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3 sm:mb-4 pr-24 sm:pr-32">
                
                <div id="score2-display" class="text-score font-black text-yellow-400 my-4 sm:my-8 cursor-pointer relative" title="Clic para sumar 1 punto">
                    0
                    <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-yellow-600 font-bold uppercase tracking-widest whitespace-nowrap">Serie Actual</span>
                </div>
                
                <div class="text-xl sm:text-3xl font-bold text-white mb-4 sm:mb-6">
                    Promedio: <span id="avg2-display">0.000</span>
                </div>

                <div class="flex space-x-2 sm:space-x-3 w-full">
                    <button id="add-point-2" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                        +1 Carambola
                    </button>
                    <button id="undo-point-2" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-5 rounded-lg text-base sm:text-lg shadow-lg transition duration-200" title="Deshacer punto">
                        &#x21A9;
                    </button>
                </div>
            </div>

        </main>

        <footer class="p-3 sm:p-4 bg-black/20 flex flex-col md:flex-row justify-center items-center space-y-3 md:space-y-0 md:space-x-4 border-t border-gray-700">
            <button id="next-inning-btn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Cambiar Turno / Fallo
            </button>
            <button id="undo-btn" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Deshacer Última Acción
            </button>
            <button id="pause-timer-btn" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Pausa
            </button>
            <button id="finish-game-btn" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Terminar Partida
            </button>
            <button id="reset-btn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-base sm:text-lg shadow-lg transition duration-200">
                Reiniciar
            </button>
        </footer>

    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-white">¿Estás seguro?</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Esta acción no se puede deshacer.</p>
            <div id="modal-results" class="hidden text-left text-gray-200 space-y-2">
                </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">Cancelar</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ESTADO DEL JUEGO ---
            let state = {
                score1: 0, 
                score2: 0, 
                inningScore1: 0, 
                inningScore2: 0, 
                innings: 0,
                currentPlayer: 1, 
                startTime: null,
                timerInterval: null, 
                numPlayers: 2,
                isPaused: false,
                pausedTime: 0,
                pauseStartTime: null,
                targetScore: 30,
                targetInnings: 0,
                
                // --- ESTADO DEL SHOT CLOCK ---
                shotClockTime: 0,      
                shotClockInterval: null,
                shotClockOvertime: false 
            };
 
            // Historial para deshacer
            let history = [];

            // --- AUDIO CONTEXT (PARA ALARMA) ---
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            function playWarningSound() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
                oscillator.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.5); 

                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            }

            // --- ELEMENTOS DEL DOM ---
            const appContent = document.getElementById('app-content');
            const setupModal = document.getElementById('setup-modal');
            const numPlayersSelect = document.getElementById('num-players');
            const player1SetupName = document.getElementById('player1-setup-name');
            const player2SetupName = document.getElementById('player2-setup-name');
            const player2SetupContainer = document.getElementById('player2-setup-container');
            const startGameBtn = document.getElementById('start-game-btn');
            
            const setupTargetScore = document.getElementById('setup-target-score');
            const setupTargetInnings = document.getElementById('setup-target-innings');
            const distanciaInput = document.getElementById('distancia');
            const inningsLimitDisplay = document.getElementById('innings-limit-display');

            const score1Display = document.getElementById('score1-display');
            const score2Display = document.getElementById('score2-display');
            const avg1Display = document.getElementById('avg1-display');
            const avg2Display = document.getElementById('avg2-display');
            const inningsDisplay = document.getElementById('innings-display');
            const panel1 = document.getElementById('player1-panel');
            const panel2 = document.getElementById('player2-panel');
            const player1NameInput = document.getElementById('player1-name');
            const player2NameInput = document.getElementById('player2-name');

            const totalScoreBox1 = document.getElementById('total-score-box-1');
            const totalScoreBox2 = document.getElementById('total-score-box-2');

            const timerDisplay = document.getElementById('timer-display');
            
            // Shot Clock Elements
            const shotClockNumber = document.getElementById('shot-clock-number');
            const shotClockBarsContainer = document.getElementById('shot-clock-bars');
            const initTimerBtn = document.getElementById('init-timer-btn');

            // Resumen global
            const summaryScore1 = document.getElementById('summary-score1');
            const summaryScore2 = document.getElementById('summary-score2');
            const summaryAvg1 = document.getElementById('summary-avg1');
            const summaryAvg2 = document.getElementById('summary-avg2');
            const summaryInnings = document.getElementById('summary-innings');
            const summaryName1 = document.getElementById('summary-name1');
            const summaryName2 = document.getElementById('summary-name2');
            const summaryPlayer2 = document.getElementById('summary-player2');

            // Botones
            const addPoint1Btn = document.getElementById('add-point-1');
            const addPoint2Btn = document.getElementById('add-point-2');
            const undoPoint1Btn = document.getElementById('undo-point-1');
            const undoPoint2Btn = document.getElementById('undo-point-2');
            const nextInningBtn = document.getElementById('next-inning-btn');
            const undoBtn = document.getElementById('undo-btn');
            const resetBtn = document.getElementById('reset-btn');
            const finishGameBtn = document.getElementById('finish-game-btn');
            const pauseTimerBtn = document.getElementById('pause-timer-btn');
 
            // Modal
            const modal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalResults = document.getElementById('modal-results');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            let confirmCallback = null;

            // --- INICIALIZACIÓN DE LA UI DEL SHOT CLOCK ---
            function initShotClockUI() {
                shotClockBarsContainer.innerHTML = '';
                for (let i = 0; i < 40; i++) {
                    const bar = document.createElement('div');
                    bar.classList.add('clock-segment');
                    bar.id = `seg-${i}`;
                    shotClockBarsContainer.appendChild(bar);
                }
            }
            initShotClockUI();

            // --- FUNCIONES DEL SHOT CLOCK ---
            function clearShotClock() {
                if (state.shotClockInterval) clearInterval(state.shotClockInterval);
                state.shotClockTime = 0;
                state.shotClockOvertime = false;
                shotClockNumber.textContent = "40";
                
                const bars = document.querySelectorAll('.clock-segment');
                bars.forEach(bar => {
                    bar.className = 'clock-segment'; 
                });
            }

            function resetShotClock() {
                clearShotClock();
                startShotClock();
            }

            function startShotClock() {
                if (state.shotClockInterval) clearInterval(state.shotClockInterval);
                
                state.shotClockInterval = setInterval(() => {
                    if (state.isPaused) return;

                    // Si estamos en overtime (después de 40s)
                    if (state.shotClockOvertime) {
                        state.shotClockTime++;
                        // Esperar 15 segundos extra
                        if (state.shotClockTime >= 15) {
                            playWarningSound();
                            // --- CAMBIO: REINICIAR AUTOMÁTICAMENTE ---
                            resetShotClock();
                        }
                        return;
                    }

                    // Tiempo normal
                    state.shotClockTime++;
                    const timeLeft = 40 - state.shotClockTime;
                    shotClockNumber.textContent = timeLeft >= 0 ? timeLeft : 0;

                    // Actualizar barra visual
                    updateShotClockVisual(state.shotClockTime);

                    if (state.shotClockTime >= 40) {
                        // Iniciar Overtime
                        state.shotClockOvertime = true;
                        state.shotClockTime = 0; 
                    }

                }, 1000);
            }

            function updateShotClockVisual(timeElapsed) {
                if (timeElapsed > 40) return;
                const barIndex = timeElapsed - 1;
                const bar = document.getElementById(`seg-${barIndex}`);
                
                if (bar) {
                    if (timeElapsed <= 20) {
                        bar.classList.add('segment-green');
                    } else if (timeElapsed <= 30) {
                        bar.classList.add('segment-orange');
                    } else {
                        bar.classList.add('segment-red');
                    }
                }
            }

            // --- FUNCIONES PRINCIPALES ---

            function formatTime(seconds) {
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            function startTimer() {
                if (!state.startTime) {
                    state.startTime = Date.now();
                }
                if (state.timerInterval) {
                    return; 
                }
                state.timerInterval = setInterval(() => {
                    if (state.isPaused) return; 
                    const elapsedMs = Date.now() - state.startTime - state.pausedTime;
                    const elapsedSeconds = Math.floor(elapsedMs / 1000);
                    timerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
            }
 
            function stopTimer() {
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
            }

            function saveState() {
                const stateCopy = JSON.parse(JSON.stringify(state));
                stateCopy.timerInterval = null;
                stateCopy.shotClockInterval = null;
                history.push(stateCopy);
                if (history.length > 50) history.shift(); 
            }

            function calculateAvg(score, innings) {
                if (innings === 0 || score === 0) return '0.000';
                return (score / innings).toFixed(3);
            }

            function updateTotalScoreColors() {
                totalScoreBox1.style.color = 'white';
                totalScoreBox2.style.color = 'white';

                if (state.numPlayers === 2) {
                    const winningColor = '#22c55e'; 
                    const losingColor = '#D12E45'; 

                    if (state.score1 > state.score2) {
                        totalScoreBox1.style.color = winningColor; 
                        totalScoreBox2.style.color = losingColor; 
                    } else if (state.score2 > state.score1) {
                        totalScoreBox2.style.color = winningColor;
                        totalScoreBox1.style.color = losingColor;
                    }
                }
            }

            function updateDisplay() {
                score1Display.textContent = state.inningScore1;
                player1NameInput.value = player1SetupName.value;
                totalScoreBox1.textContent = state.score1;
                
                if (state.numPlayers === 2) {
                    score2Display.textContent = state.inningScore2;
                    player2NameInput.value = player2SetupName.value;
                    totalScoreBox2.textContent = state.score2;
                }
                
                updateTotalScoreColors();

                inningsDisplay.textContent = state.innings;

                let p1AvgInnings = state.innings > 0 ? (state.currentPlayer === 1 ? state.innings - 1 : state.innings) : 0;
                let p2AvgInnings = state.innings > 0 ? state.innings - 1 : 0;
                
                if (state.innings === 0) {
                     avg1Display.textContent = '0.000';
                     avg2Display.textContent = '0.000';
                } else {
                    avg1Display.textContent = calculateAvg(state.score1, p1AvgInnings > 0 ? p1AvgInnings : 1);
                    if (state.numPlayers === 2) {
                        avg2Display.textContent = calculateAvg(state.score2, p2AvgInnings > 0 ? p2AvgInnings : 1);
                    }
                }
                
                panel1.classList.remove('player-active', 'border-yellow-400', 'player-active-bg');
                panel2.classList.remove('player-active', 'border-yellow-400', 'player-active-bg');
                panel1.classList.add('bg-gray-700/50');
                panel2.classList.add('bg-gray-800/50');

                if (state.currentPlayer === 1) {
                    panel1.classList.add('player-active', 'border-yellow-400', 'player-active-bg');
                    panel1.classList.remove('bg-gray-700/50'); 
                } else if (state.numPlayers === 2) {
                    panel2.classList.add('player-active', 'border-yellow-400', 'player-active-bg');
                    panel2.classList.remove('bg-gray-800/50'); 
                }
 
                summaryName1.textContent = player1NameInput.value;
                summaryScore1.textContent = state.score1;
                summaryAvg1.textContent = calculateAvg(state.score1, p1AvgInnings > 0 ? p1AvgInnings : 1);
                
                if (state.numPlayers === 2) { 
                    summaryPlayer2.classList.remove('hidden'); 
                    summaryName2.textContent = player2NameInput.value; 
                    summaryScore2.textContent = state.score2;
                    summaryAvg2.textContent = calculateAvg(state.score2, p2AvgInnings > 0 ? p2AvgInnings : 1);
                } else {
                    summaryPlayer2.classList.add('hidden'); 
                }
                summaryInnings.textContent = state.innings;

                if (state.numPlayers === 1) {
                    panel2.classList.add('hidden');
                    panel1.classList.remove('md:w-1/2');
                    panel1.classList.add('w-full');
                } else {
                    panel2.classList.remove('hidden');
                    panel1.classList.add('md:w-1/2');
                    panel1.classList.remove('w-full');
                }

                if (state.isPaused) {
                    pauseTimerBtn.textContent = 'Reanudar';
                    pauseTimerBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                    pauseTimerBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                } else {
                    pauseTimerBtn.textContent = 'Pausa';
                    pauseTimerBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
                    pauseTimerBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                }
            }
 
            function showConfirmation(title, message, onConfirm, showResults = false, resultsHtml = '') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalResults.innerHTML = resultsHtml;

                if (showResults) {
                    modalMessage.classList.add('hidden');
                    modalResults.classList.remove('hidden');
                    modalConfirmBtn.classList.add('hidden'); 
                    modalCancelBtn.textContent = 'Cerrar';
                    modalCancelBtn.onclick = hideConfirmation; 
                } else {
                    modalMessage.classList.remove('hidden');
                    modalResults.classList.add('hidden');
                    modalConfirmBtn.classList.remove('hidden');
                    modalCancelBtn.textContent = 'Cancelar';
                    modalCancelBtn.onclick = hideConfirmation; 
                    confirmCallback = onConfirm;
                }
                modal.classList.remove('hidden');
            }

            function hideConfirmation() {
                modal.classList.add('hidden');
                confirmCallback = null;
                modalCancelBtn.textContent = 'Cancelar';
            }


            // --- MANEJADORES DE EVENTOS ---

            numPlayersSelect.addEventListener('change', (e) => {
                if (e.target.value === '1') {
                    player2SetupContainer.classList.add('hidden');
                } else {
                    player2SetupContainer.classList.remove('hidden');
                }
            });

            startGameBtn.addEventListener('click', () => {
                state.numPlayers = parseInt(numPlayersSelect.value);
                player1NameInput.value = player1SetupName.value;
                state.targetScore = parseInt(setupTargetScore.value) || 0;
                state.targetInnings = parseInt(setupTargetInnings.value) || 0;
                
                distanciaInput.value = state.targetScore > 0 ? state.targetScore : '';
                
                if (state.targetInnings > 0) {
                    inningsLimitDisplay.textContent = `/ ${state.targetInnings}`;
                    inningsLimitDisplay.classList.remove('hidden');
                } else {
                    inningsLimitDisplay.classList.add('hidden');
                }

                if (state.numPlayers === 2) {
                    player2NameInput.value = player2SetupName.value;
                }

                setupModal.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                initializeGame(); 
            });

            // BOTÓN "I" -> INICIA TIMER POR PRIMERA VEZ
            initTimerBtn.addEventListener('click', () => {
                resetShotClock();
            });

            // Handlers de puntos (NO REINICIAN EL SHOT CLOCK)
            function handleAddPoint1() {
                saveState();
                state.score1++; 
                state.inningScore1++; 
                state.currentPlayer = 1;
                if (state.innings === 0) state.innings = 1;
                startTimer();
                updateDisplay();
            }
            addPoint1Btn.addEventListener('click', handleAddPoint1);
            score1Display.addEventListener('click', handleAddPoint1);

            function handleAddPoint2() {
                if (state.numPlayers === 1) return; 
                saveState();
                state.score2++; 
                state.inningScore2++; 
                state.currentPlayer = 2;
                if (state.innings === 0) state.innings = 1;
                startTimer();
                updateDisplay();
            }
            addPoint2Btn.addEventListener('click', handleAddPoint2);
            score2Display.addEventListener('click', handleAddPoint2);

            undoPoint1Btn.addEventListener('click', () => {
                if (state.score1 > 0 && state.inningScore1 > 0) {
                    saveState();
                    state.score1--;
                    state.inningScore1--;
                    updateDisplay();
                }
            });

            undoPoint2Btn.addEventListener('click', () => {
                if (state.numPlayers === 1) return;
                if (state.score2 > 0 && state.inningScore2 > 0) {
                    saveState();
                    state.score2--;
                    state.inningScore2--;
                    updateDisplay();
                }
            });

            // --- BOTÓN AZUL: CAMBIAR TURNO ---
            // ESTE ES EL QUE RESETEA EL TIMER MANUALMENTE
            nextInningBtn.addEventListener('click', () => {
                saveState();
                
                state.inningScore1 = 0;
                state.inningScore2 = 0;
                
                if (state.numPlayers === 1) {
                    state.innings++;
                } else {
                    if (state.currentPlayer === 1) {
                        state.currentPlayer = 2; 
                    } else {
                        state.currentPlayer = 1; 
                        state.innings++; 
                    }
                }
                if (state.innings === 0) state.innings = 1;
                
                startTimer();
                resetShotClock(); 
                updateDisplay();
            });

            undoBtn.addEventListener('click', () => {
                if (history.length > 0) {
                    const lastState = history.pop();
                    if (!lastState.timerInterval) stopTimer();
                    
                    state.score1 = lastState.score1;
                    state.score2 = lastState.score2;
                    state.inningScore1 = lastState.inningScore1;
                    state.inningScore2 = lastState.inningScore2;
                    state.innings = lastState.innings;
                    state.currentPlayer = lastState.currentPlayer;
                    
                    updateDisplay();
                }
            });

            pauseTimerBtn.addEventListener('click', () => {
                if (!state.startTime) return; 

                if (state.isPaused) {
                    state.isPaused = false;
                    if (state.pauseStartTime) {
                        state.pausedTime += (Date.now() - state.pauseStartTime);
                    }
                    state.pauseStartTime = null;
                } else {
                    state.isPaused = true;
                    state.pauseStartTime = Date.now(); 
                }
                updateDisplay(); 
            });
 
            finishGameBtn.addEventListener('click', () => {
                if (!state.isPaused && state.startTime) {
                    state.isPaused = true;
                    state.pauseStartTime = Date.now();
                }
                if(state.shotClockInterval) clearInterval(state.shotClockInterval);
 
                let durationSeconds = 0;
                if (state.startTime) {
                    let elapsedMs = 0;
                    if (state.pauseStartTime) { 
                        elapsedMs = (state.pauseStartTime - state.startTime) - state.pausedTime;
                    } else if (state.startTime) { 
                        elapsedMs = Date.now() - state.startTime;
                    }
                    durationSeconds = Math.floor(elapsedMs / 1000);
                }
                
                const durationFormatted = formatTime(durationSeconds);
                
                let p1AvgInnings = state.innings > 0 ? (state.currentPlayer === 1 ? state.innings - 1 : state.innings) : 1;
                if (p1AvgInnings < 1) p1AvgInnings = 1;
                
                let p2AvgInnings = state.innings > 0 ? state.innings - 1 : 1;
                if (p2AvgInnings < 1) p2AvgInnings = 1;

                const finalAvg1 = calculateAvg(state.score1, p1AvgInnings);
                const finalAvg2 = calculateAvg(state.score2, p2AvgInnings);

                let resultsHtml = `
                    <h4 class="text-xl font-bold text-yellow-400 mb-4">Resultados de la Partida:</h4>
                    <p><strong>Duración:</strong> ${durationFormatted}</p>
                    <p><strong>Entradas Totales:</strong> ${state.innings}</p>
                    <hr class="my-3 border-gray-600">
                    <p><strong>${player1NameInput.value}:</strong></p>
                    <ul>
                        <li>Carambolas: ${state.score1}</li>
                        <li>Promedio: ${finalAvg1}</li>
                    </ul>
                `;

                if (state.numPlayers === 2) {
                    resultsHtml += `
                        <hr class="my-3 border-gray-600">
                        <p><strong>${player2NameInput.value}:</strong></p>
                        <ul>
                            <li>Carambolas: ${state.score2}</li>
                            <li>Promedio: ${finalAvg2}</li>
                        </ul>
                    `;
                }
                
                showConfirmation('Partida Terminada', '', null, true, resultsHtml);
            });

            resetBtn.addEventListener('click', () => {
                showConfirmation(
                    'Reiniciar Aplicación', 
                    '¿Estás seguro de que quieres salir? Volverás a la pantalla de configuración.', 
                    () => {
                        stopTimer(); 
                        if(state.shotClockInterval) clearInterval(state.shotClockInterval);
                        appContent.classList.add('hidden');
                        setupModal.classList.remove('hidden');
                        hideConfirmation();
                    }
                );
            });
 
            modalCancelBtn.addEventListener('click', hideConfirmation);
            modalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
            });

            function initializeGame() {
                stopTimer();
                if (state.shotClockInterval) clearInterval(state.shotClockInterval);

                state = {
                    score1: 0,
                    score2: 0,
                    inningScore1: 0, 
                    inningScore2: 0, 
                    innings: 0,
                    currentPlayer: 1,
                    startTime: null,
                    timerInterval: null,
                    numPlayers: state.numPlayers,
                    isPaused: false,
                    pausedTime: 0,
                    pauseStartTime: null,
                    targetScore: state.targetScore,
                    targetInnings: state.targetInnings,
                    shotClockTime: 0,
                    shotClockInterval: null,
                    shotClockOvertime: false
                };
                history = []; 
                timerDisplay.textContent = '00:00:00';
                
                clearShotClock();
                updateDisplay();
            }
        });
    </script>
</body>

</html>
